<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>JMPerez Blog</title>
  <subtitle>Web development, performance, and some other good practices.</subtitle>
  <link href="/feed.xml" rel="self"/>
  
  <link href="https://jmperezperez.com/"/>
  <updated>2016-12-09T10:48:34.000Z</updated>
  <id>https://jmperezperez.com/</id>
  
  <author>
    <name>Jose M. Perez</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Using MediaRecorder API for screen recording on the web</title>
    <link href="https://jmperezperez.com/mediarecorder-api-screenflow/"/>
    <id>https://jmperezperez.com/mediarecorder-api-screenflow/</id>
    <published>2016-12-08T23:05:00.000Z</published>
    <updated>2016-12-09T10:48:34.000Z</updated>
    
    <content type="html"><![CDATA[<p>At <a href="/cssconf-au-2016/">CSSConf AU 2016</a>, <a href="https://soledadpenades.com/" target="_blank" rel="external">Soledad Penadés</a> gave a talk called “<a href="https://soledadpenades.com/files/t/2016_rtalchemy/" target="_blank" rel="external">Real time front-end alchemy</a>“. It was full of examples of combining <a href="https://developer.mozilla.org/en-US/docs/Web/API/Media_Streams_API" target="_blank" rel="external">MediaStreams</a> with audio and video manipulation.</p><p>Something I didn’t know was that you can record audio and video on the browser without any plugins. You can combine audio from the microphone, video from a canvas, dynamically generated content… you name it. Even recording a window or the entire screen and exporting it as a video.</p><a id="more"></a><p>The best way to learn is by practising and, <a href="https://soledadpenades.com/files/t/2016_rtalchemy/#65" target="_blank" rel="external">quoting Soledad</a>, “we need you to play with it, contribute and help us make it better”. By trying these new APIs out we let browser-vendors know that these tools are useful, and we can test and provide early feedback.</p><h2 id="The-project"><a href="#The-project" class="headerlink" title="The project"></a>The project</h2><video width="720" height="450" controls poster="/assets/images/posts/screenflow-poster.jpg"><source src="/assets/images/posts/screenflow-output.webm" type="video/webm"><source src="/assets/images/posts/screenflow-output.mp4" type="video/mp4"></video><p>I had this idea about creating a <a href="http://www.telestream.net/screenflow/overview.htm" target="_blank" rel="external">ScreenFlow</a>-like prototype. I would show my webcam in a corner of the screen and I would generate a video combining audio from the mic and the image from the screen.</p><p>I Googled a bit, and found very few sites talking about these APIs. Pretty much only <a href="https://developer.mozilla.org/en-US/docs/Web/API/MediaStream_Recording_API" target="_blank" rel="external">MDN</a> and <a href="https://hacks.mozilla.org/2016/04/record-almost-everything-in-the-browser-with-mediarecorder/" target="_blank" rel="external">other post by Sole</a>. I thought this small experiment would also help those searching for some examples.</p><p><em>Note: As of December 2016 this demo is only supported on Firefox. Chrome is not supported out of the box, needing an extension and lots of custom code (see this WebRTC experiment for more information. It will show your camera, but won’t record anything.</em></p><h3 id="The-code"><a href="#The-code" class="headerlink" title="The code"></a>The code</h3><p>The code for the project is at <a href="https://github.com/JMPerez/screenflow" target="_blank" rel="external">JMPerez/screenflow on GitHub</a> and a demo is available on <a href="https://jmperezperez.com/screenflow/">jmperezperez.com/screenflow</a>.</p><p>Let’s have a look at the most important code fragments. First of all, we define functions to request access to the different media sources:</p><figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// we ask for permission to record the screen</span></div><div class="line"><span class="keyword">const</span> getStreamForScreen = <span class="function"><span class="params">()</span> =&gt;</span> navigator.mediaDevices.getUserMedia(&#123;</div><div class="line">  <span class="attr">video</span>: &#123;</div><div class="line">    <span class="attr">mediaSource</span>: <span class="string">'screen'</span></div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// we ask for permission to record the audio and video from the camera</span></div><div class="line"><span class="keyword">const</span> getStreamForCamera = <span class="function"><span class="params">()</span> =&gt;</span> navigator.mediaDevices.getUserMedia(&#123;</div><div class="line">   <span class="attr">audio</span>: <span class="literal">true</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure><p>Now, we execute them, one after the other one. I tried to execute both in parallel, believing that the browser would combine both requests in the permission dialog, but that didn’t work. So the idea is to request access to the webcam, insert a <code>&lt;video&gt;</code> element with the media from the camera and then request access to the screen and record it.</p><figure class="highlight js"><table><tr><td class="code"><pre><div class="line">getStreamForCamera().then(<span class="function"><span class="params">streamCamera</span> =&gt;</span> &#123;</div><div class="line">    <span class="comment">// we know have access to the camera, let's append it to the DOM</span></div><div class="line">    <span class="comment">// appendCamera(streamCamera);</span></div><div class="line">    getStreamForScreen().then(<span class="function"><span class="params">streamScreen</span> =&gt;</span> &#123;</div><div class="line"></div><div class="line">      <span class="comment">// we now have access to the screen too</span></div><div class="line">      <span class="comment">// we generate a combined stream with the video from the</span></div><div class="line">      <span class="comment">// screen and the audio from the camera</span></div><div class="line">      <span class="keyword">var</span> finalStream = <span class="keyword">new</span> MediaStream();</div><div class="line">      <span class="keyword">const</span> videoTrack = streamScreen.getVideoTracks()[<span class="number">0</span>];</div><div class="line">      finalStream.addTrack(videoTrack);</div><div class="line">      <span class="keyword">const</span> audioTrack = streamCamera.getAudioTracks()[<span class="number">0</span>];</div><div class="line">      finalStream.addTrack(audioTrack);</div><div class="line">      <span class="keyword">this</span>.recorder = <span class="keyword">new</span> MediaRecorder(finalStream);</div><div class="line"></div><div class="line">      <span class="comment">// we subscribe to 'ondataavailable'.</span></div><div class="line">      <span class="comment">// this gets called when the recording is stopped.</span></div><div class="line">      <span class="keyword">this</span>.recorder.ondataavailable = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">        <span class="comment">// let's create a blob with e.data which has the</span></div><div class="line">        <span class="comment">// contents of the video in webm</span></div><div class="line">        <span class="keyword">var</span> link = <span class="built_in">document</span>.createElement(<span class="string">'a'</span>);</div><div class="line">        link.setAttribute(<span class="string">'href'</span>, <span class="built_in">window</span>.URL.createObjectURL(e.data));</div><div class="line">        link.setAttribute(<span class="string">'download'</span>, <span class="string">'video_'</span> + <span class="built_in">Math</span>.floor((<span class="built_in">Math</span>.random() * <span class="number">999999</span>)) + <span class="string">'.webm'</span>);</div><div class="line">        link.style.display = <span class="string">'none'</span>;</div><div class="line">        <span class="built_in">document</span>.body.appendChild(link);</div><div class="line">        link.click();</div><div class="line">        <span class="built_in">document</span>.body.removeChild(link);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// start recording</span></div><div class="line">      <span class="keyword">this</span>.recorder.start();</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div></pre></td></tr></table></figure><p>Now, we finally need to call <code>this.recorder.stop()</code> whenever we want to stop the recording, which will make the browser save the file automatically. In my example, I’m attaching a key event listener for the “escape” key.</p><h3 id="A-note-about-permissions"><a href="#A-note-about-permissions" class="headerlink" title="A note about permissions"></a>A note about permissions</h3><p>In order to make this work you will need to whitelist the domain trying to record your screen. On Firefox, <code>localhost</code> will work out of the box. If you want to publish the code somewhere else, like GitHub Pages, make sure you whitelist it.</p><p>On Firefox, navigate to <code>about:config</code> and look for the key <code>media.getusermedia.screensharing.allowed_domains</code>. Add your domain to the list and restart the browser. Then, when you are running the code, the user will be able to grant access for both the webcam and the screen.</p><p>It is unclear whether this will be how a user lets a site record their screen, but it is how this works at the moment.</p><h3 id="A-step-further-making-this-embeddable"><a href="#A-step-further-making-this-embeddable" class="headerlink" title="A step further, making this embeddable"></a>A step further, making this embeddable</h3><p>The example code worked fine, but I wanted to take it a bit further. What if I wanted to use this “recording” functionality in more than one project? Also, given that the user has to whitelist a domain, we could serve the code from an <code>iframe</code> on that domain, so we wouldn’t need to add more domains to the <code>about:config</code>.</p><p>The final version of the prototype is based now on a script that you include on a page. The script appends an <code>iframe</code>, which executes the code we saw above and shows the output from the webcam at full size. Apart from the <code>iframe</code>, it also binds several key event listeners to toggle the visibility and size of the <code>iframe</code>.</p><p>These are the keys you can press to perform some actions:</p><ul><li>Escape: finishes the recording and saves the file</li><li>s: Switches the camera between full page and picture-in-picture</li><li>a: Toggles the visibility of the camera</li></ul><p>You can then include the script to any page to get this screen recording functionality. For instance, we can include <code>https://jmperezperez.com/screenflow/lib/embed.js</code> on a codepen and record a screencast.</p><h3 id="Limitations"><a href="#Limitations" class="headerlink" title="Limitations"></a>Limitations</h3><p>Keep in mind this is only a proof of concept and doesn’t have any real utility. If you are serious about recording a screencast, don’t use this hack :)</p><p>There are, of course, some limitations:</p><ul><li>The iframe with the camera is shown on top of the hosting page, but it will be hidden if we put some other window on top.</li><li>If we navigate from the hosting page to somewhere else we will lose the recording. This can be workaround by having, in the hosting page, an iframe for the camera and another iframe for the page we are recording, in full screen</li><li>If we click on the iframe with the camera, the key events will stop working because the hosting page doesn’t receive those. This can be solved sending <code>postMessage</code>s from the iframe to the hosting page.</li></ul>]]></content>
    
    <summary type="html">
    
      Record your webcam and screen using Javascript to create screencast from your browser.
    
    </summary>
    
    
      <category term="images" scheme="https://jmperezperez.com/tags/images/"/>
    
  </entry>
  
  <entry>
    <title>Speaking at CSSConf Australia 2016</title>
    <link href="https://jmperezperez.com/cssconf-au-2016/"/>
    <id>https://jmperezperez.com/cssconf-au-2016/</id>
    <published>2016-12-01T09:46:00.000Z</published>
    <updated>2016-12-01T10:46:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>I just attended <a href="http://2016.cssconf.com.au" target="_blank" rel="external">CSSConf Australia in Melbourne</a>, where I gave a talk about images and web performance. It was a blast! Very well organised and with a great atmosphere. In this post I give a short introduction about the event and I include links to the slides, videos and the script. <img src="/assets/images/posts/cssconf-au-2016-sign.jpg" alt="The CSSConf AU 2016 sign at the entrance"></p><a id="more"></a><h2 id="Call-for-Papers-and-Organization"><a href="#Call-for-Papers-and-Organization" class="headerlink" title="Call for Papers and Organization"></a>Call for Papers and Organization</h2><p>Back in August I sent a proposal for <a href="http://2016.cssconf.com.au/call-for-speakers/" target="_blank" rel="external">CSSConf AU 2016’s Call For Papers</a> and I got accepted. Just by reading their CFP it was clear this event was very well organised. I liked that the projects and companies mentioned in the CFP had to be renamed to PROJECT_A, COMPANY_A, etc to make the selection process more fair. It’s also refreshing seeing speakers with very different background, and I love how the organisation has made diversity and inclusion the pillars of the triplet CSSConf / JSConf / Decompress. Details like the variety of food and live captioning show that they are serious about it.</p><p>As a speaker, they have been very supportive providing all the information about the event way ahead of time, and offering help with the design of the slides and preparation. And once in Melbourne they also prepared a nice welcome pack, including a SIM card that has been great for me to be in contact with my family during these days.</p><p>When they say it’s taken them 9 months to prepare the conference I don’t question it. One can see they had covered every little detail.</p><p>I recommend to check <a href="http://brett.cool/photoessays/2016/cssconfau/" target="_blank" rel="external">Brett Jones’ write-up about the event</a>, that is full with great pictures and descriptions about the talks.</p><p>Personally, it’s the first time I travel so far from home, and I have also accomplished a personal dream of speaking at a top-level large conference.</p><h2 id="My-talk-about-“Progressive-Image-Rendering”"><a href="#My-talk-about-“Progressive-Image-Rendering”" class="headerlink" title="My talk about “Progressive Image Rendering”"></a>My talk about “Progressive Image Rendering”</h2><p>The talk I gave is based on some posts I have been writing during last 1.5 years. It’s a combination of insights while redesigning (and rewriting) <a href="https://open.spotify.com" target="_blank" rel="external">open.spotify.com</a>, plus some smaller projects I had been working on, also related with images.</p><p>A month before the talk, the folks at <a href="https://www.meetup.com/es-ES/Stockholm-Web-Performance-Group/events/234796510/" target="_blank" rel="external">Stockholm Web Performance Group</a> gave me a slot in one of their Meetups to present it, which was really useful to get feedback. I fixed some typos, investigated some information that was missing and adjusted the length. Presenting it to a smaller audience made me present a first version of the talk, which I polished thanks to their feedback and an extended Q&amp;A session, and be more confident.</p><h3 id="Slides-and-video"><a href="#Slides-and-video" class="headerlink" title="Slides and video"></a>Slides and video</h3><p>The slides are available on <a href="https://jmperezperez.com/cssconfau16/">jmperezperez.com/cssconfau16</a> and contain some animations and videos. A <em>static</em> version <a href="https://speakerdeck.com/jmperez/progressive-image-rendering" target="_blank" rel="external">is available on SpeakerDeck</a>.</p><iframe width="560" height="315" src="//speakerdeck.com/player/26551189899c4996a8f9fae2b5e8e10a"></iframe><p><a href="https://www.youtube.com/watch?v=skzcEKewOwc#t=06h29m38s" target="_blank" rel="external">The video of the talk is on Youtube</a>:</p><iframe width="560" height="315" src="https://www.youtube.com/embed/skzcEKewOwc#t=06h29m38s" frameborder="0" allowfullscreen></iframe><p>Last, but not least, <a href="https://twitter.com/ghammadi" target="_blank" rel="external">Guillaume Hammadi</a> drew this amazing illustration that summarises the talk:</p><p><blockquote class="twitter-tweet" data-lang="en-gb"><p lang="en" dir="ltr">Progressive image <a href="https://twitter.com/hashtag/rendering?src=hash" target="_blank" rel="external">#rendering</a> by <a href="https://twitter.com/jmperezperez" target="_blank" rel="external">@jmperezperez</a> at <a href="https://twitter.com/cssconfau" target="_blank" rel="external">@cssconfau</a> <a href="https://twitter.com/hashtag/cssconfau16?src=hash" target="_blank" rel="external">#cssconfau16</a> <a href="https://t.co/pKtcWWvjVL" target="_blank" rel="external">pic.twitter.com/pKtcWWvjVL</a></p>&mdash; guillaume hammadi (@ghammadi) <a href="https://twitter.com/ghammadi/status/803830326657249282" target="_blank" rel="external">30 November 2016</a></blockquote></p><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script><h3 id="Script"><a href="#Script" class="headerlink" title="Script"></a>Script</h3><p>Here is the script I had prepared for the talk. Of course I failed to stick to 100%.</p><hr><h4 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h4><p>As users we like applications and websites to load fast, or at least feel like the load fast. As developers we struggle finding the best way to optimize and serve the assets needed for our projects in the best way.</p><p>We tend to talk a lot about the size of CSS and JS. We love discussing about this or that library, on saving some bytes at the cost of functionality. React vs preact?</p><p>It is very easy to forget about images. Images still represent roughly two thirds of the size of a web page, and the trend is pretty stable, increasing over time. Let’s not forget about the main culprit.</p><p>In this presentation I want to discuss about images, making the case for using them and only then find the best way to serve them. I will talk about different ways to load images that some sites and applications use in real life. They try to improve the user’s perceived performance using placeholders, blurry thumbnails and dominant colours.</p><p>Some of them are not as standard as we would like them to be, but they are there to fill a gap.</p><p>Like most of the developer, I try to get up to date with the latest techniques to build fast and pretty websites. I try many things, but only a few end up working. Some of those techniques are good in theory, but don’t cover our use case completely.</p><p>I will show some examples of pages we implemented and some of the issues we found addressing image performance.</p><h4 id="The-case-for-using-images"><a href="#The-case-for-using-images" class="headerlink" title="The case for using images"></a>The case for using images</h4><p>We’ve been using images on the web for a long time. Not only to show nice pictures, but also for rounded corners and gradients before CSS finished with these hacks. But it would be silly to try to improve the perceived performance of images that are not optimized, or are even unneeded.</p><p>With the trend of flat and minimalist design we have reduced the need of images on the web. Fewer images also means less problems to make our site look good on multiple devices without sending too many bytes down the wire. And reducing images, especially bitmap ones, prevents us from generating several sizes and keeping an “original” image for future modifications (think of PSD files).</p><p>The fact of reducing the need of images also means that there is more bandwidth to load other resources. This is especially important in slow networks.</p><p>Some images might look great on desktop but provide little value on mobile. Maybe we don’t even need to load that image in certain viewports. Setting the display property to “none” will hide the image, but won’t prevent the browser from requesting it. A better alternative is to set a background-image using CSS. Similarly, hiding sections in your markup that contain images won’t prevent the request. A better approach is to use a template engine that only adds to the markup the needed section. These days lots of people use a component-based library that will take care of this.</p><h4 id="Optimising-images"><a href="#Optimising-images" class="headerlink" title="Optimising images"></a>Optimising images</h4><p>I can’t find a reason why not to optimize images. We have had good tools like jpegoptim and imageoptim for a long time. They will output the same image with fewer bytes. For formats like JPEG it is difficult for us to choose what compression level we should use. 80? 90? It really depends on the source image. There are tools that will find the best compression level to generate an image that is visually identical to a given one.</p><p>Performance is a difficult topic. A heavier page might be perceived as faster. Think of a page that inlines its critical CSS and lazy loads the full stylesheet. Overall, it is sending more bytes, but it will be perceived as faster.</p><h4 id="Picture-element-and-srcset-sizes"><a href="#Picture-element-and-srcset-sizes" class="headerlink" title="Picture element and srcset/sizes"></a>Picture element and srcset/sizes</h4><p>We have seen examples where we could avoid requesting an image and have gone through optimizations that we can apply to an image. For large images we have a valuable HTML element and img’s attributes we can use. We can finally use responsive images in all modern browsers. You define what images you want to serve depending on some media queries.</p><p>In theory it is a good approach, in practice I see two things that are far from ideal.</p><p>Firstly, the browser knows the dimensions of the window, but needs extra information to pick the right image to download. This is so it can request the images without having to wait until the CSS is downloaded and parsed. The markup can get quite verbose, and these values depend on the visual design, which CSS is supposed to dictate. In the end you end up with duplication, and it is not easy to defined those media queries once and import them both in CSS and HTML.</p><p>Secondly, the lack of a standard lazy-loading solution. Most users don’t scroll through the whole page, and it makes sense to delay the request of images below the fold until they are needed. The most performant request is the one that is never made. You want to use <code>&lt;img&gt;</code> for all images, since it’s the most sensible and standard thing to do. But the browser sees them and requests all of them even if they are far from the visible area. I wish there was a way for browsers to do this in a standard way.</p><p>A middle ground is to use responsive images for above the fold content, and lazy load the rest. This is in fact what we do in Spotify for pages like albums, where we display the cover art above the fold, and then we show a section with more albums by that artist, in which we lazy load the images.</p><h4 id="How-to-lazy-load"><a href="#How-to-lazy-load" class="headerlink" title="How to lazy load"></a>How to lazy load</h4><p>When doing lazy load, we want to detect when the page is scrolled or resized, and then check whether the placeholder for our image is within the rendered section of the page. And this needs to be performed for all the images we want to lazy load.</p><p>Scroll listeners can have a negative impact in scrolling performance. During the scroll movement, the browser triggers many scroll events, and finding out the position and dimension of our images causes a layout recalculation. This is an expensive operation that makes the browser spend too long drawing frames, producing stuttering when scrolling. So what should be an improvement might spoil the perceived performance.</p><p>There is an experimental API called IntersectionObserver that suits very well this use case. Instead of subscribing to the scroll event, and then go through the lazy-loaded images, IntersectionObserver allows us to subscribe to an event that is triggered when the image enters the rendered area (viewport).</p><p>It is supported in Chrome and Opera, and in development in Firefox and Edge.</p><h4 id="What-to-show-while-the-image-is-loading"><a href="#What-to-show-while-the-image-is-loading" class="headerlink" title="What to show while the image is loading"></a>What to show while the image is loading</h4><p>An interesting topic in loading images is what to show until the image is downloaded. And this is even more important when doing lazy loading.</p><p>When the image is loading we can do several things. The easiest one is not to do anything. We reserve some area in which the image will be eventually loaded. Another possibility is showing a placeholder. If you do this, try to use inlined SVG so they are served quicker.</p><p>Then we have the more interesting options. One could fill the area where an image is going to be loaded with a solid colour. The colour will be obtained from the image. It can be the dominant colour, the more vivid colour… There are libraries to extract these colours as a palette. A drawback is that you need some pre-processing of your images to calculate these colours.</p><p>One last option is to use a small version of the image, like a thumbnail, scale it and apply a blur effect. For this one you need to generate that smaller image, so it is the option that increases the size of the overall page the most.</p><p>Solid colour and blurry images are the ones that are used to improve user’s perceived performance. We will see how real sites put them in practice.</p><h4 id="Examples-of-solid-colour"><a href="#Examples-of-solid-colour" class="headerlink" title="Examples of solid colour"></a>Examples of solid colour</h4><p>First of all, let’s see examples of using a solid colour as the background.</p><p>Google added recently an option to Google Chrome, especially targeted to slow connections. In those cases it doesn’t serve images, replacing them with a solid colour. Then, once the user taps on “Load images”, those images are requested.</p><p>Arts and Culture is another example by Google, where you can browse art from museums. The placeholders give us a hint: we know that an image will appear there, we know the dimensions and we see a pleasant colour that transitions to the full image.</p><p>We don’t need to go too far to see this in action. Search for images on Google and you’ll see those placeholders. In case you are wondering, I was throttling the connection to record this. But if you are using a shared connection, or using internet on a plane, you will see them.</p><h4 id="Examples-of-Progressive-Image-Loading"><a href="#Examples-of-Progressive-Image-Loading" class="headerlink" title="Examples of Progressive Image Loading"></a>Examples of Progressive Image Loading</h4><p>Moving on, let’s see some examples of sites that show a blurry image to transition to the final image.</p><p>One of the biggest sites using it is Medium. In this video we can see what the transition looks like. And because is web, we can inspect and see what’s going on behind the scenes. In order to do this they render a div, then they request a small thumbnail image, which they draw to a canvas. Then thy apply a blur effect. At the same time they request the large image, and when it is received they replace the canvas with the image.</p><p>The markup for the technique includes a <code>&lt;div&gt;</code> for setting an intrinsic aspect ratio, then we have the small image, the large one, the canvas and a <code>&lt;noscript&gt;</code> tag to support browsers with JS disabled.</p><p>There are 2 interesting points in Medium’s implementation. One is that the thumbnail, though very small, it’s an external file. They could as well have inlined it in the initial payload. Secondly, <code>&lt;canvas&gt;</code> is an option for accomplishing the blur effect, but so are blur filter that can be applied using CSS or SVG.</p><p>Overall, one can’t say it is straightforward, but the point is to achieve lazy-loading of images, and a seamless transition between a small thumbnail and the large image to improve perceived performance.</p><h4 id="How-do-users-perceive-it"><a href="#How-do-users-perceive-it" class="headerlink" title="How do users perceive it?"></a>How do users perceive it?</h4><p>It seems fair to ask ourselves how do users see it?. I searched on Twitter to find some reactions and this is what I found.</p><p>But since this is a subjective topic, we also find people who don’t like it. This shouldn’t surprise us. We have had a similar technique for a long time in the form of progressive JPEGs. However, only 7% of JPEG images are progressive.</p><blockquote><p>“When, as with the Progressive JPEG method, image rendition is a two-stage process in which an initially coarse image snaps into sharp focus, cognitive fluency is inhibited and the brain has to work slightly harder to make sense of what is being displayed.”</p></blockquote><p>Users find it more difficult to process progressive JPEGs, even though at first sight we would think the experience is better.</p><h4 id="Is-this-technique-reliable"><a href="#Is-this-technique-reliable" class="headerlink" title="Is this technique reliable?"></a>Is this technique reliable?</h4><blockquote><p>“If you’re viewing this on desktop and the above image looks a bit blurry, please refresh the page…”</p></blockquote><p>It turns out that sometimes users end up just seeing the blurry images… which is probably worst than not seeing nothing at all.</p><h4 id="Facebook-Inlining-thumbnail-image-in-payload"><a href="#Facebook-Inlining-thumbnail-image-in-payload" class="headerlink" title="Facebook - Inlining thumbnail image in payload"></a>Facebook - Inlining thumbnail image in payload</h4><p>Medium are not alone on this. Facebook has also experimented with it for their mobile client in developing markets like India. For loading a profile page for a user, their app would make a request to fetch the data, which included the url for the cover photo image. Then, they needed to make a second request to fetch the image.</p><p>This is pretty standard, but they wanted to try to serve a small version of the image in the payload of the first request. They decided it should be smaller than 200 bytes for this to be worth it.</p><p>There was a problem, though. The headers of a JPEG image are larger of 200 bytes, but removing it they were close to 200 bytes. So they decided to use a common header for all images, which is stored in their client, and then only the JPEG data is returned.</p><p>Quite creative, right? In the path to solve the problem with loading images, we end up questioning the current formats and find work-arounds.</p><h4 id="Generating-tiny-thumbnails"><a href="#Generating-tiny-thumbnails" class="headerlink" title="Generating tiny thumbnails"></a>Generating tiny thumbnails</h4><p>I came across the article several months after it was posted. When I read it I wondered, how small can JPEG images be? I scaled down a few cover arts to 42x42 pixels, which is the size Facebook uses according to their post. And effectively, they were larger than their 200 Bytes budget.</p><p>Then I tried with other formats, like GIF and PNG, but they were even bigger. Until I tried with WebP, which resulted in roughly 1/4th of the size of the JPEG. One could say that the images are not exactly the same, and they are right. But once we apply a blur effect they look almost the same.</p><p>Regarding support for WebP, we should keep in mind that Facebook was trying to solve this for their mobile client. And there are libraries for rendering WebP on Android and iOS, so this seems a good solution.</p><h4 id="Getting-creative-with-SVGs"><a href="#Getting-creative-with-SVGs" class="headerlink" title="Getting creative with SVGs"></a>Getting creative with SVGs</h4><p>Who doesn’t like SVGs? They are powerful and they can also be applied to image loading.</p><p>Some time ago I came across this site. It’s a review for the PS4 on Polygon.com. They use SVGs with an animation that looks like the image is being drawn.</p><p>Given a SVG it is easy to apply an animation of the stroke dash, as we see in this Spotify logo. On my quest to finding other ways to represent images, I thought of this technique. Sure thing, given a SVG we can “draw” it. But how can we apply this to bitmap images? Do we need to vectorize them?</p><p>It turns out we can draw the edges of an image. For that, we can detect the edges using an algorithm like Canny Edge. And the result is quite fun. The SVG is drawn and finally transitioned to the full image. We can detect edges, create polylines with SVG following those edges and apply the same technique we just saw to animate them.</p><p>The idea would be to pre-generate SVGs server-side, and inline them in the HTML. We have full control on how many lines to draw and the amount of detail. We can use a smaller version of the image to generate the points, still getting an accurate set of polylines. And the resulting SVG can be further optimized with svgo, and its size is around 2 or 3kB.</p><h4 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h4><p>Should we do this? I believe these techniques should be part of your toolbelt. The picture element is great for some applications, but we need to consider other scenarios like lazy-loading. Every approach has its advantages and disadvantages and we should use the more appropriate tool.</p><p>The Web is fun. You can right click and see the source code. The web is a great environment for anyone to learn. Go and experiment making your site faster.</p><p>Thanks!</p>]]></content>
    
    <summary type="html">
    
      I spoke at CSSConf AU 2016 in Melbourne about images on the web and what we can do to reduce their impact in our site&#39;s performance.
    
    </summary>
    
    
      <category term="images" scheme="https://jmperezperez.com/tags/images/"/>
    
  </entry>
  
  <entry>
    <title>JPG compression level, SSIM and Jpeg.io</title>
    <link href="https://jmperezperez.com/ssim-jpeg-io/"/>
    <id>https://jmperezperez.com/ssim-jpeg-io/</id>
    <published>2016-10-14T15:43:00.000Z</published>
    <updated>2016-11-21T08:15:19.000Z</updated>
    
    <content type="html"><![CDATA[<p>The size of images in JPG varies a lot based on the compression level we choose when saving them. Often, we tweak this level by hand until we consider we don’t have too many artifacts and the resulting image is close enough to the original one.</p><p>The same compression level doesn’t generate the same amount of artifacts in two different images. We need to find an automated approach that measures how different (or similar) two images are, and loop through several compression levels to find the most suitable one.</p><a id="more"></a><h2 id="Structural-similarity"><a href="#Structural-similarity" class="headerlink" title="Structural similarity"></a>Structural similarity</h2><p>Some time ago I discovered <a href="https://github.com/technopagan/cjpeg-dssim" target="_blank" rel="external">cjpeg-ddsim</a> at <a href="/internetdagarna-2015/#High-Performance-Images-by-Tobias-Baldauf">a talk</a> by <a href="http://tobias.is/about/" target="_blank" rel="external">Tobias Baldauf</a> who works at Akamai and has written several tools for optimising images.</p><p><a href="https://en.wikipedia.org/wiki/Structural_similarity" target="_blank" rel="external">Structural similarity</a> is used for measuring the similarity between two images, which can be applied to our use case. Tobias himself has <a href="https://github.com/technopagan/adept-jpg-compressor" target="_blank" rel="external">a script</a> that goes through the whole process of applying SSIM to an image, though you will need to install some libraries to run it.</p><h2 id="ImageOptim-and-JPEG-io"><a href="#ImageOptim-and-JPEG-io" class="headerlink" title="ImageOptim and JPEG.io"></a>ImageOptim and JPEG.io</h2><p>I’m a big fan of automated tools like <a href="https://imageoptim.com" target="_blank" rel="external">ImageOptim</a>. Since I normally have full control on the assets of my projects, I can pass the images through it once and commit them optimised.</p><p>ImageOptim performs a <a href="/image-optimization-lossy-lossless-techniques">lossless optimisation</a> by default, removing EXIF data and preview images that are not needed. A lossy mode is available and can be enabled from the app’s preferences panel. Lossy presents the same problem, though. What compression level is the right one?</p><p><img src="/assets/images/posts/imageoptim-lossy.png" alt="Imageoptim&#39;s Preferences"></p><p>Reading <a href="http://frontendfocus.co/issues/261" target="_blank" rel="external">this week’s FrontEnd Focus (formerly HTML5 Weekly) newsletter</a> I found out about <a href="https://www.jpeg.io" target="_blank" rel="external">Jpeg.io</a>. This site claims to convert any image into a highly Optimized JPEG, so I decided to give it a try.</p><p>I run it through all JPG images on this blog, and I liked seeing that there were savings even though the images had already been optimised:</p><p><img src="/assets/images/posts/jpeg-io-results.png" alt="Jpeg.io results for some of the images of this blog"></p><p>Some images were left untouched, while others reduced their size as much as 70% (<a href="/assets/images/posts/spotify-hack-week-2014-presentation-before.jpg">before 236kB</a>, <a href="/assets/images/posts/spotify-hack-week-2014-presentation.jpg">after 71kB</a>).</p><h3 id="Progressive-JPEGs"><a href="#Progressive-JPEGs" class="headerlink" title="Progressive JPEGs"></a>Progressive JPEGs</h3><p>Another advantage is that it generates <a href="http://blog.patrickmeenan.com/2013/06/progressive-jpegs-ftw.html" target="_blank" rel="external">progressive JPGs</a>. Compared to baseline JPGs, progressive ones will render a larger area of the image earlier, though more <em>pixelated</em>. It provides a standard way to progressive load images without having to do something as fancy as <a href="/medium-image-progressive-loading-placeholder/">Medium’s technique</a>.</p><p>Note, however, that users might prefer baseline images, <a href="http://www.webperformancetoday.com/2014/09/17/progressive-image-rendering-good-evil/" target="_blank" rel="external">according to a study</a>, which was later <a href="http://conferences.oreilly.com/velocity/velocityny2014/public/schedule/detail/35658" target="_blank" rel="external">presented at Velocity</a>:</p><blockquote><p>When, as with the Progressive JPEG method, image rendition is a two-stage process in which an initially coarse image snaps into sharp focus, cognitive fluency is inhibited and the brain has to work slightly harder to make sense of what is being displayed</p></blockquote><h3 id="Customisation"><a href="#Customisation" class="headerlink" title="Customisation"></a>Customisation</h3><p>Jpeg.io doesn’t have any customisation options like image quality or compression. They don’t give too many details about the process they apply <a href="https://www.jpeg.io/about" target="_blank" rel="external">on their site</a>, but they do seem to do some kind of SSIM processing:</p><blockquote><p>Jpeg.io is a free online interface for rapidly and conveniently converting your images into highly optimized JPEGs using Kraken.io’s proprietary JPEG optimization algorithms. […] you’ll get a progressive JPEG compressed to the smallest possible size without perceptible quality loss.</p></blockquote><p>Kraken.io also offers <a href="https://kraken.io/web-interface" target="_blank" rel="external">an alternative web interface</a> where they do have some level of customisation, and show the percentage of savings per file.</p><h2 id="Future-of-SSIM-based-optimisation-tools"><a href="#Future-of-SSIM-based-optimisation-tools" class="headerlink" title="Future of SSIM-based optimisation tools"></a>Future of SSIM-based optimisation tools</h2><p>I do hope that we see more libraries that make use of image similarity and we can be easily used in our build pipelines and CMSs.</p>]]></content>
    
    <summary type="html">
    
      It&#39;s difficult to select the best compression level for JPG images. SSIM helps measuring image similarity, and tools like Jpeg.io makes it easier.
    
    </summary>
    
    
      <category term="images" scheme="https://jmperezperez.com/tags/images/"/>
    
  </entry>
  
  <entry>
    <title>Lazy-loading images on the web to improve loading time and saving bandwidth</title>
    <link href="https://jmperezperez.com/lazy-loading-images/"/>
    <id>https://jmperezperez.com/lazy-loading-images/</id>
    <published>2016-07-31T05:30:00.000Z</published>
    <updated>2016-12-09T10:18:06.000Z</updated>
    
    <content type="html"><![CDATA[<p>tl;dr: Don’t load images that the user doesn’t see on screen. It is easier than you think.</p><a id="more"></a><h2 id="What-is-lazy-loading"><a href="#What-is-lazy-loading" class="headerlink" title="What is lazy loading"></a>What is lazy loading</h2><p>Everyone has seen lazy loading content on web sites and mobile apps. You start seeing some content, and as you scroll, more content gets loaded.</p><h2 id="A-web-page-and-all-its-requests"><a href="#A-web-page-and-all-its-requests" class="headerlink" title="A web page and all its requests"></a>A web page and all its requests</h2><p>In the case of web pages, it hasn’t been that easy for developers to find the balance between creating many small resources or serving a big one. A trend these days consist of inlining critical resources, the ones needed to render content above the fold, and load the rest of CSS and JS asynchronously. This is easy to do in small static sites, but more difficult for larger sites with dynamic content.</p><p>Delaying the request to some assets has lots of benefits:</p><ul><li>Less data usage for the user. This is especially important on mobile, where lots of users have poor network connections and restrictive data plans.</li><li>The server or CDN has to serve less data, which translates to a cheaper bill for the site.</li><li>Important content gets prioritised. The same bandwidth is used by fewer requests in parallel, so it is more likely that they are solved faster.</li><li>Less work for the browser. The browser doesn’t need to parse nor decode assets that are not requested.</li></ul><p>As with everything, this technique also comes with some disadvantages. Let’s focus on lazy loading of images.</p><h2 id="Lazy-loading-images"><a href="#Lazy-loading-images" class="headerlink" title="Lazy loading images"></a>Lazy loading images</h2><p>I will talk about how we can get big wins focusing on delaying the load of images.</p><p>We can have a quick look at <a href="https://spotify.com/" target="_blank" rel="external">spotify.com home page</a>:</p><video width="1194" height="798" controls><source src="/assets/images/posts/spotify-com-loading-images.webm" type="video/webm"><source src="/assets/images/posts/spotify-com-loading-images.mp4" type="video/mp4"></video><p>We load the page, then clear the network tab, which is filtered to show only requests for images. As we scroll down the page, more images are requested, accounting for ~1.1MB.</p><p>Lazy loading images gives full control to select what image needs to be loaded (eg a 2x version for a retina display, or a 1x when in slower connections). It is also possible to create smooth transitions of opacity or blurriness to create nice effects. I recommend you to read <a href="/medium-image-progressive-loading-placeholder/">a previous post about progressive image rendering</a> to see some examples.</p><p>Despite is advantages, this technique also has its drawbacks.</p><h2 id="Drawbacks-of-lazy-loading-images"><a href="#Drawbacks-of-lazy-loading-images" class="headerlink" title="Drawbacks of lazy loading images"></a>Drawbacks of lazy loading images</h2><h3 id="JavaScript-based"><a href="#JavaScript-based" class="headerlink" title="JavaScript based"></a>JavaScript based</h3><p>So far, browsers don’t support a native way of marking a certain image to be lazy loaded. The solutions are JavaScript-based, which means that it won’t work if the browser has JS disabled or the request for the JS snippet fails.</p><p><a href="https://gds.blog.gov.uk/2013/10/21/how-many-people-are-missing-out-on-javascript-enhancement/" target="_blank" rel="external">This is not so unlikely</a>, and content-blockers are becoming more widespread used, both on desktop and mobile. For JS disabled browsers, it is possible to implement a fallback using <code>&lt;noscript&gt;</code>, although this won’t work if the browser uses some kind of content blocker for JS files.</p><h3 id="Scroll-listeners-and-relayouts"><a href="#Scroll-listeners-and-relayouts" class="headerlink" title="Scroll listeners and relayouts"></a>Scroll listeners and relayouts</h3><p>When doing lazy load, we want to detect when the page is scrolled, and then check whether the placeholder for our image is within the rendered section of the page. And this needs to be performed for all the images we want to lazy load.</p><p>Scroll listeners can have a negative impact in scrolling performance. During the scroll movement, the browser triggers many scroll events, and finding out the position and dimension of our images causes <a href="https://gist.github.com/paulirish/5d52fb081b3570c81e3a" target="_blank" rel="external">a layout recalculation</a>. This is an expensive operation that makes the browser spend too long drawing frames, producing <a href="http://jankfree.org/" target="_blank" rel="external">stuttering when scrolling</a>.</p><p>To avoid it, JS developers usually cache dimensions and positions of some elements, and use throttling and debouncing to execute the scroll callback fewer times. Last, but not least, there is an experimental API called <a href="https://developers.google.com/web/updates/2016/04/intersectionobserver" target="_blank" rel="external">IntersectionObserver</a> that suits very well this use case. Instead of subscribing to the scroll event, and then go through the lazy-loaded images, IntersectionObserver allows us to subscribe to an event triggered when the image enters the rendered area (viewport).</p><h3 id="Fallback-content-and-viewport"><a href="#Fallback-content-and-viewport" class="headerlink" title="Fallback content and viewport"></a>Fallback content and viewport</h3><p>When an image is displayed within the rendered area, we know it needs to be fetched. But we could also fetch it when, not being strictly within the rendered area, it is very close to it. This reduces the likeliness that a placeholder is rendered without its image, but can also mean requesting images that will never be displayed.</p><p>Finally, we need to think of what will be rendered in the placeholder while the images are fetched. A possibility is to show an empty area. Why not an area filled with a dominant colour? You can revisit <a href="/medium-image-progressive-loading-placeholder/">the post about progressive image rendering</a> to get some ideas.</p><h3 id="Browser-limitations"><a href="#Browser-limitations" class="headerlink" title="Browser limitations"></a>Browser limitations</h3><p>Some browsers may limit how much work is done while scrolling. WebKit on iOS 7 scroll event change <a href="http://developer.telerik.com/featured/scroll-event-change-ios-8-big-deal/" target="_blank" rel="external">used to be fired when the scroll gesture stopped</a>, making it impossible to load. Fortunately, most used browsers today don’t present this limitation.</p><h2 id="An-example-Spotify-Open-pages"><a href="#An-example-Spotify-Open-pages" class="headerlink" title="An example: Spotify Open pages"></a>An example: Spotify Open pages</h2><p>The <a href="https://open.spotify.com/" target="_blank" rel="external">Spotify’s Open site</a>, where it shows information about Spotify catalogue, have been using lazy loading for the images for more than a year. Let’s use <a href="https://open.spotify.com/track/7oSUp4yZ0FbuSvVmCxH2ty?noredir=1" target="_blank" rel="external">a track page</a> as an example.</p><p>The main goal of the page is for the user to have information about the track, and click the Call to Action button (green button) to open the track in a Spotify client or sign up. That’s why it’s crucial that these elements are shown above the fold.</p><p>The main image is not lazy loaded. Doing so would delay its rendering since the browser would need to first parse and execute the JS code that does the lazy loading, and then the image would be requested. However, the rest of the images below the fold, like the ones showing more albums by the same artist, don’t need to be fetched until the user scrolls down and they enter the screen. <img src="/assets/images/posts/open-pages-structure.png" alt="Structure of a Spotify Open page."></p><p>The Open site uses a small library that provides lazy loading. Due to its small size, it can also be inlined in the markup, so there is no need to make a request for the script and images are requested a bit earlier.</p><p>Instead of using the src attribute of an <code>&lt;img/&gt;</code> to point to the image file, we use data-src. We can also add 2x versions of the images, that will get loaded if the browser screen is a retina display.</p><p>Internally, the library makes sure the scrolling performance is not affected when using lazy load. It uses passive event listeners, throttles scroll events, caches image dimensions, and don’t process images already loaded. Finally, it uses IntersectionObserver on supported browsers, avoiding listening to the scroll event and asking for properties from the images.</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>When building a website, consider lazy loading the assets when they are needed. This is both good for the user and the site’s servers and CDNs.</p>]]></content>
    
    <summary type="html">
    
      When building a website, consider lazy loading the assets when they are needed. This post will focus in the specific case of lazy loading images.
    
    </summary>
    
    
      <category term="images" scheme="https://jmperezperez.com/tags/images/"/>
    
      <category term="lazy-loading" scheme="https://jmperezperez.com/tags/lazy-loading/"/>
    
  </entry>
  
  <entry>
    <title>Some things I learned implementing Data Fetching for Universal Web Apps</title>
    <link href="https://jmperezperez.com/data-fetching-universal-apps/"/>
    <id>https://jmperezperez.com/data-fetching-universal-apps/</id>
    <published>2016-07-16T15:40:00.000Z</published>
    <updated>2016-11-21T08:15:32.000Z</updated>
    
    <content type="html"><![CDATA[<p>Javascript is not just a language for the browser. Node.JS is becoming popular as a platform to run JS on the server. We are learning how to build modular websites where business logic and state are not coupled with the markup. And finally we are getting the tools to build universal web apps. But what are universal apps, and why should we care about data fetching?</p><a id="more"></a><h2 id="Universal-Isomorphic-apps"><a href="#Universal-Isomorphic-apps" class="headerlink" title="Universal/Isomorphic apps"></a>Universal/Isomorphic apps</h2><p>The community hasn’t decided on what to call them yet, but for the sake of consistency I’ll be referring to them as <em>universal</em> web apps. These projects have 2 main features:</p><ul><li>The server runs JS</li><li>Most of the code of the project is shared between browser and server.</li></ul><p>For a long time we tangled business logic with markup. We would generate some HTML in the server and JS would run in the client to make AJAX requests and changes in the DOM.</p><p>This worked for most websites, but today lots of projects start as a SPA. Their state is managed in a single place and the server just provides the initial page and a set of endpoints that return data to the view. But this approach has caused <a href="https://blog.twitter.com/2012/improving-performance-on-twittercom" target="_blank" rel="external">long page load times</a> and bad SEO forced rethinking the web.</p><p>The best way to provide fast-loading pages is to server-side render them. Though service workers might help eventually, the initial request needs to reach the server. To compose the page, the server needs to identify the user, fetch some data and generate the markup through some template system. After the initial load, JS comes in and replaces full page loads with some data fetching and markup composition.</p><p>Here we can see that some code will be duplicated, especially in SPAs. A way to improve this is by running JS in the server and trying to write code that is decoupled from the DOM. Server-side rendering can be seen these days as an enhancement for SPAs.</p><h2 id="Data-fetching-in-universal-apps"><a href="#Data-fetching-in-universal-apps" class="headerlink" title="Data fetching in universal apps"></a>Data fetching in universal apps</h2><p>In universal apps, most of the code can be shared between browser and server. One of the pieces that differs is data fetching. Node.JS has its own way to make requests, and neither <code>XMLHttpRequest</code> nor <code>fetch</code> is supported. <img src="/assets/images/posts/universal-data-fetching.png" alt="Universal request libraries abstract your code from how a request is made."></p><p>There exists many libraries that will perform the async requests using the mechanism available in the platform running the code. Some of them try to polyfill <code>fetch</code> in Node, others polyfill <code>http</code> in the browser. In our code we <code>require</code>/<code>import</code> them, and then the code is included in the bundle served to the browser using browserify or webpack.</p><h3 id="Choosing-a-universal-request-package"><a href="#Choosing-a-universal-request-package" class="headerlink" title="Choosing a universal request package"></a>Choosing a universal request package</h3><p>Regardless of which request library one you choose, <strong>be aware of how they contribute to the bundle size</strong>. Ideally, these libraries should represent a rather small chunk of the bundle, but I have been doing some tests and the results are pretty interesting.</p><p>I have used browserify to create a bundle just requiring each of there libraries separately, and then uglified the output. The size shown is minified, not gzipped:</p><ul><li><a href="https://github.com/jedmao/iso-http" target="_blank" rel="external">iso-http 0.0.5</a>: 4kB</li><li><a href="https://github.com/matthew-andrews/isomorphic-fetch" target="_blank" rel="external">isomorphic-fetch 2.2.1</a>: 9kB</li><li><a href="https://github.com/visionmedia/superagent" target="_blank" rel="external">superagent 2.0.0</a>: 9kB</li><li><a href="https://github.com/mzabriskie/axios" target="_blank" rel="external">axios 0.13.0</a>: 20kB</li><li><a href="https://registry.npmjs.org/isomorphic-request" target="_blank" rel="external">isomorphic-request 1.0.0</a>: 240kB</li><li><a href="https://github.com/bitinn/node-fetch" target="_blank" rel="external">node-fetch 1.5.3</a>: 489kB</li></ul><p>Note that these packages might not have the same features, and I haven’t tried most of them myself. In some cases it might be worth creating your custom request library accesses the endpoints you are using. But all in all these libraries should generate code that wraps <code>XMLHttpRequest</code> and its response.</p><p>Notice the big difference in size between them, all the way from 4kB to 489kB. How can that be? For that we need to understand what is going on when our code is bundled.</p><h3 id="Bundling-of-Node’s-APIs"><a href="#Bundling-of-Node’s-APIs" class="headerlink" title="Bundling of Node’s APIs"></a>Bundling of Node’s APIs</h3><p>Something I learnt while creating those bundles is that it is very useful to double check the generated code. <strong>If the required code includes some feature only available in Node, the bundler will add the JS code for it in the output bundle.</strong></p><p>An example is <code>Buffer</code>, which <a href="https://github.com/thelinmichael/spotify-web-api-node/blob/cf9b5834b828b38b659afd82fb85ae742d5ea0eb/src/spotify-web-api.js#L1241" target="_blank" rel="external">I was using in a wrapper for the Spotify Web API</a>. Since <code>Buffer</code> is not supported in the browser environment, which accounts to 44kB of JS (minified).</p><p>Same thing can happen with these request libraries when they include code that is supposed to be only run in Node.JS and not on the browser.</p><h3 id="The-browser-field"><a href="#The-browser-field" class="headerlink" title="The browser field"></a>The <code>browser</code> field</h3><p>When you are bundling some JS code that is going to be run only on the server, do not include it in the bundle that is going to be run on the browser. This applies both if you are writing a site and if you are writing a library that will be used by another project.</p><p>For this, use the <a href="https://github.com/defunctzombie/package-browser-field-spec" target="_blank" rel="external"><code>browser</code> field</a> in the <code>package.json</code> file. It is used, amongst others, to define what file needs to be replaced by other when bundling. When using webpack, make sure <a href="https://webpack.github.io/docs/configuration.html#target" target="_blank" rel="external"><code>target</code></a> is not set or set to <code>&#39;web&#39;</code>.</p><p>You can see an example <a href="https://github.com/visionmedia/superagent/blob/83892f35fe15676a4567a0eb51eecd096939ad36/package.json#L54" target="_blank" rel="external">in the superagent source code</a>:</p><figure class="highlight js"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span>: <span class="string">"superagent"</span>,</div><div class="line">  ...</div><div class="line">  <span class="string">"browser"</span>: &#123;</div><div class="line">    <span class="string">"./lib/node/index.js"</span>: <span class="string">"./lib/client.js"</span>,</div><div class="line">    ...</div><div class="line">  &#125;,</div><div class="line">  ...</div><div class="line">  <span class="string">"main"</span>: <span class="string">"./lib/node/index.js"</span>,</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>or <a href="https://github.com/jedmao/iso-http/blob/33870ab0ee79d93e73ad55d787c99c5f5e07f936/package.json#L6" target="_blank" rel="external">iso-http</a>:</p><figure class="highlight js"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span>: <span class="string">"iso-http"</span>,</div><div class="line">  ...</div><div class="line">  <span class="string">"main"</span>: <span class="string">"js/node/Http.js"</span>,</div><div class="line">  <span class="string">"browser"</span>: <span class="string">"js/browser/Http.js"</span>,</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>From the libraries I tested, 4 of them were using <code>browser</code> and 2 of them not. These 2 are precisely the ones that generate the largest bundle files.</p><h3 id="Getting-stats-about-a-bundle"><a href="#Getting-stats-about-a-bundle" class="headerlink" title="Getting stats about a bundle"></a>Getting stats about a bundle</h3><p>It is not straightforward to know what modules are contributing the most size to the output bundle. One way you can try is by creating an entry JS file that only includes the module you are interested in, which is what I did when comparing request libraries. But if you are using webpack, a better way is to use <a href="https://github.com/chrisbateman/webpack-visualizer" target="_blank" rel="external">webpack-visualizer</a>.</p><p>This tool generates a pie chart with all the required dependencies and makes it straightforward to find the culprit. <img src="/assets/images/posts/node-fetch-webpack-stats.png" alt="iconv-lite and pako are the main contributors to node-fetch bundle size"> <em>^ iconv-lite and pako are the main contributors to node-fetch bundle size</em></p><h3 id="One-more-thing-ES6-imports"><a href="#One-more-thing-ES6-imports" class="headerlink" title="One more thing: ES6 imports"></a>One more thing: ES6 imports</h3><p>A great way to reduce the footprint of a library is by exporting it in pieces. Thanks to ES6 and tree-shaking, one can import a subset of functions and symbols from a library, which can reduce largely the size of the output bundle.</p><p>This is really useful if you are implementing a wrapper for your API endpoints. It is convenient to support all the endpoints, but an app might only be interesting in using a few of those.</p><p>I have started experimenting with this building <a href="https://github.com/JMPerez/spotify-web-api-js-poc" target="_blank" rel="external">a new wrapper for the Spotify Web API</a> that exposes each endpoint as an exported function, so that the unused endpoints are not part of the generated code.</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Universal apps are great, and so is sharing lots of code between server and client. As important as a fast rendering time is the time it takes the browser to download, parse and execute the JS that provides the client-side functionality. Keep an eye on your imports, and prevent including code that is not intended to be run on the browser.</p>]]></content>
    
    <summary type="html">
    
      Webpack and Browserify generate large bundles if we include Node.JS code to be run on the browser. In this post you will learn how to prevent this issue.
    
    </summary>
    
    
      <category term="isomorphic" scheme="https://jmperezperez.com/tags/isomorphic/"/>
    
      <category term="universal" scheme="https://jmperezperez.com/tags/universal/"/>
    
      <category term="webpack" scheme="https://jmperezperez.com/tags/webpack/"/>
    
      <category term="browserify" scheme="https://jmperezperez.com/tags/browserify/"/>
    
      <category term="node" scheme="https://jmperezperez.com/tags/node/"/>
    
  </entry>
  
  <entry>
    <title>The importance of personal side projects</title>
    <link href="https://jmperezperez.com/personal-projects/"/>
    <id>https://jmperezperez.com/personal-projects/</id>
    <published>2016-04-05T16:05:00.000Z</published>
    <updated>2016-11-21T08:15:37.000Z</updated>
    
    <content type="html"><![CDATA[<p>This blog you are reading is more a tool for me to consolidate some ideas and experiences I come across. So is <a href="https://github.com/JMPerez" target="_blank" rel="external">my GitHub account</a>, where I upload some small projects that otherwise would remain on my computer and eventually die. It is also a way of <em>giving back</em>: I have learned may things reading other people’s posts and code, and I hope someone can find what I do useful.</p><a id="more"></a><p>Posting my code on GitHub also forces me to improve its readability, documentation and testability. They are an opportunity to test build tools, libraries &amp; frameworks and different ways of structuring a web project. They help me get a grasp of the implications of picking one tool over the other in applications larger than a “Hello World”, and I can make more informed decisions on what to use when I am faced with a real project at work.</p><h2 id="A-practical-case"><a href="#A-practical-case" class="headerlink" title="A practical case"></a>A practical case</h2><p>I was involved in the implementation of a web site that needed to be live in less than one week. Fortunately I could put together pieces of several side projects and meet the deadline. I used file drag &amp; drop from a project, JS-based unzipping from another one, a wrapper for the Spotify Web API, a throttler for promises and the build tools and general structure of the website from another one. All of them pet projects that I decided to tidy up a bit and put at reach.</p><p>I learned that not only side projects are useful as a way to experiment, give back and build a portfolio, but also as components of a toolbelt that can be very handy when the occasion presents itself.</p><h2 id="Do-it"><a href="#Do-it" class="headerlink" title="Do it"></a>Do it</h2><p>Even if you think that you don’t have anything useful to share with the world, open-source your projects or become a contributor of a project you like. These are really exciting times and it’ ha’s never been that easy to collaborate.</p>]]></content>
    
    <summary type="html">
    
      Side projects are fun, and they will add value to your daily work when it is most needed.
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Spotify&#39;s new brand identity using feColorMatrix SVG filters</title>
    <link href="https://jmperezperez.com/duotone-using-fecolormatrix/"/>
    <id>https://jmperezperez.com/duotone-using-fecolormatrix/</id>
    <published>2016-02-14T10:40:00.000Z</published>
    <updated>2016-11-21T08:16:06.000Z</updated>
    
    <content type="html"><![CDATA[<p>This is a short post where I show how to use SVG and a <code>feColorMatrix</code> filter to apply a duotone effect to an image.</p><a id="more"></a><p>Demo &amp; Code: <a href="http://codepen.io/jmperez/pen/LGqaxQ" target="_blank" rel="external">http://codepen.io/jmperez/pen/LGqaxQ</a></p><p>You may have seen that the <a href="http://www.fastcodesign.com/3043547/spotifys-new-look-signals-its-identity-shift" target="_blank" rel="external">Spotify’s new brand identity</a> is full of duotone images. My colleague Thodoris described how to achieve this effect <a href="http://blog.72lions.com/blog/2015/7/7/duotone-in-js" target="_blank" rel="external">in JS</a> and <a href="http://blog.72lions.com/blog/2015/7/18/duotone-in-ios" target="_blank" rel="external">in iOS</a>.</p><p>The JS version uses <code>&lt;canvas&gt;</code>, and after reading <a href="http://alistapart.com/article/finessing-fecolormatrix" target="_blank" rel="external">A List Apart’s Finessing feColorMatrix</a>, where they also mention the duotone images used in <a href="https://yearinmusic.spotify.com" target="_blank" rel="external">Spotify’s Year in Music</a>, I forked <a href="http://codepen.io/72lions/pen/jPzLJX" target="_blank" rel="external">Thodoris’ pen</a> and used <code>feColorMatrix</code> instead:</p><p></p><p data-height="367" data-theme-id="0" data-slug-hash="LGqaxQ" data-default-tab="result" data-user="jmperez" class="codepen">See the Pen <a href="http://codepen.io/jmperez/pen/LGqaxQ/" target="_blank" rel="external">Duotone effect (Spotify Duotone) - Using feColumnMatrix</a> by José Manuel Pérez (<a href="http://codepen.io/jmperez" target="_blank" rel="external">@jmperez</a>) on <a href="http://codepen.io" target="_blank" rel="external">CodePen</a>.</p><script async src="//assets.codepen.io/assets/embed/ei.js"></script><p>The code consists of a <code>&lt;svg/&gt;</code> that has an <code>&lt;image/&gt;</code> to which we apply a <code>&lt;filter /&gt;</code>. The filter uses a <code>feColorMatrix</code>, and its values are calculated using JS, though if you already know the range of colours you want to apply there is no need to run JS, just set them in the markup. If you have any issues understanding how the matrix is calculated, check <a href="http://stackoverflow.com/questions/21977929/match-colors-in-fecolormatrix-filter" target="_blank" rel="external">this question on StackOverflow</a>.</p>]]></content>
    
    <summary type="html">
    
      Using feColorMatrix SVG filters to apply a duotone effect to an image.
    
    </summary>
    
    
      <category term="svg" scheme="https://jmperezperez.com/tags/svg/"/>
    
  </entry>
  
  <entry>
    <title>SVG Optimisation using SVGOMG and FontForge</title>
    <link href="https://jmperezperez.com/optimising-svgs/"/>
    <id>https://jmperezperez.com/optimising-svgs/</id>
    <published>2016-01-30T07:40:00.000Z</published>
    <updated>2016-11-21T08:16:11.000Z</updated>
    
    <content type="html"><![CDATA[<p><style>.language-xml{white-space: normal}</style>Lots of websites have started replacing their icon fonts and small icons with SVGs. They support CSS manipulations, animations and are great for responsive sites. But it is important to keep an eye on their size.</p><a id="more"></a><h2 id="How-SVGs-are-included-in-a-page"><a href="#How-SVGs-are-included-in-a-page" class="headerlink" title="How SVGs are included in a page"></a>How SVGs are included in a page</h2><p>Since the SVGs are usually small in size, lots of developers decide to inline them. Especially when replacing a web icon font, which can be fetch in a single request.</p><p>Some sites inline the SVGs as part of their CSS file. This can be done uri-encoding the SVG data, or converting it to base 64, but <a href="https://css-tricks.com/probably-dont-base64-svg/" target="_blank" rel="external">this one results in a larger payload</a>. <a href="/assets/images/posts/svg-inline-html-use.png"><img src="/assets/images/posts/svg-inline-html-use.png" alt="Including SVGs in the markup"></a></p><p>Some other sites include them as part of the markup, defining them as <code>&lt;symbol /&gt;</code>s, and adding a reference to them where they should be rendered through the <code>&lt;use /&gt;</code> tag. I like this one because it is easier to just serve the SVGs used in that page. If you use this, remember to define the symbols above the reference to them, or some browsers (e.g. Safari on iPhone) will not render the SVGs. <a href="/assets/images/posts/svg-inline-css.png"><img src="/assets/images/posts/svg-inline-css.png" alt="Including SVGs inlined in the CSS"></a></p><p>In any case, the SVGs are making their way to the critical path, and saving bytes won’t result in a worse experience.</p><h2 id="Next-step-optimise-the-SVGs"><a href="#Next-step-optimise-the-SVGs" class="headerlink" title="Next step, optimise the SVGs"></a>Next step, optimise the SVGs</h2><p>So far we have our SVGs on the page and they are rendered. SVGs are text-based and they compress really well. However, there is normally room for improvement and we can shave some bytes using an optimiser.</p><p>If you have used ImageOptim to optimise bitmap images, then you will love this one. <a href="https://jakearchibald.github.io/svgomg/" target="_blank" rel="external">SVGOMG</a> is a website where you drag&amp;drop your SVG and get an optimised version. It uses <a href="https://github.com/svg/svgo" target="_blank" rel="external">svgo</a>, which you can also use from the console or as part of your build process.</p><p>SVGO will optimise paths and merge layers. If you want to be able to open the optimised SVG and edit in in some tool like Inkscape, remember to save the original one somewhere else.</p><h2 id="Going-beyond-more-optimisations"><a href="#Going-beyond-more-optimisations" class="headerlink" title="Going beyond, more optimisations"></a>Going beyond, more optimisations</h2><p>If you have read this far, you will welcome ideas to further optimise your SVGs. A few weeks ago I came across a series of posts by <a href="https://twitter.com/larsenwork" target="_blank" rel="external">Andreas Larsen</a> on Medium that I strongly recommend checking out:</p><ul><li><a href="https://medium.com/larsenwork-andreas-larsen/optimising-svgs-for-web-use-part-1-67e8f2d4035#.2bnvih6cw" target="_blank" rel="external">Optimising SVGs for Web Use - Part 1</a></li><li><a href="https://medium.com/larsenwork-andreas-larsen/optimising-svgs-for-web-use-part-2-6711cc15df46#.al4v73web" target="_blank" rel="external">Optimising SVGs for Web Use - Part 2</a></li><li><a href="https://medium.com/larsenwork-andreas-larsen/optimising-svgs-for-web-use-part-2-1-598815d74f9c#.rv7i93abh" target="_blank" rel="external">Optimising SVGs for Web Use - Part 2½</a></li></ul><p>Optimising SVGs “by hand” might look a bit tedious and only at reach of a few ones, but the gains are big.</p><h2 id="An-example-Spotify-logo"><a href="#An-example-Spotify-logo" class="headerlink" title="An example: Spotify logo"></a>An example: Spotify logo</h2><p>I decided to try to use some of Andreas’ ideas and try to optimise the Spotify logo.</p><p><a href="/assets/images/posts/spotify-fontforge.png"><img src="/assets/images/posts/spotify-fontforge.png" alt="Editing the Spotify logo in fontForge"></a></p><p>This is what I did:</p><ol><li>Install fontForge: I had to install X11 and then fontForge. fontForge can be used to create and edit fonts, so the grid and rules have been thought for that use case. Still, it can be used for a regular SVG.</li><li>Import the SVG that you want to optimise.</li><li>Scale it up using Element &gt; Transformations &gt; Transform. We will be rounding the values to integers, so try to find a multiplier that will reduce the <em>error</em> when rounding. Rounding the numbers means that we remove the decimal part, but be careful not to scale the SVG up a lot, or the integer part will also grow.</li><li>Simplify the path using <code>Element &gt; Simplify &gt; Simplify</code>. If you see some path being oversimplified, undo and simplify the rest.</li><li>Round to integer using <code>Element &gt; Round &gt; To Int</code>.</li><li>In my case, I had to tweak the position of the SVG. It might be because I was using wrong values for ascent, descent, underline and height. You can use <code>Element &gt; Font Info &gt; General</code> to modify these values.</li><li>Export it as SVG.</li><li>Open <a href="https://jakearchibald.github.io/svgomg/" target="_blank" rel="external">SVGOMG</a>, import the resulting SVG and download the optimised one.</li></ol><p>In my case it went down from 2.24kB to 915 bytes, both compressed as reported by SVGOMG.</p><p>Original:</p><figure class="highlight html"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">id</span>=<span class="string">"Layer_1"</span> <span class="attr">style</span>=<span class="string">"enable-background:new 0 0 566.93 170.04"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">xml:space</span>=<span class="string">"preserve"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 566.93 170.04"</span> <span class="attr">version</span>=<span class="string">"1.1"</span> <span class="attr">y</span>=<span class="string">"0px"</span> <span class="attr">x</span>=<span class="string">"0px"</span> <span class="attr">xmlns:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> <span class="attr">width</span>=<span class="string">"567"</span> <span class="attr">height</span>=<span class="string">"171"</span> <span class="attr">fill</span>=<span class="string">"#000000"</span>&gt;</span><span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"m87.996 1.277c-46.249 0-83.743 37.493-83.743 83.742 0 46.254 37.494 83.745 83.743 83.745 46.251 0 83.743-37.491 83.743-83.745 0-46.246-37.49-83.738-83.744-83.738zm38.404 120.78c-1.504 2.467-4.718 3.24-7.177 1.737-19.665-12.019-44.417-14.734-73.567-8.075-2.809 0.644-5.609-1.117-6.249-3.925-0.643-2.809 1.11-5.609 3.926-6.249 31.9-7.293 59.263-4.154 81.336 9.334 2.46 1.51 3.24 4.72 1.73 7.18zm10.25-22.799c-1.894 3.073-5.912 4.037-8.981 2.15-22.505-13.834-56.822-17.841-83.447-9.759-3.453 1.043-7.1-0.903-8.148-4.35-1.04-3.453 0.907-7.093 4.354-8.143 30.413-9.228 68.221-4.758 94.071 11.127 3.07 1.89 4.04 5.91 2.15 8.976zm0.88-23.744c-26.994-16.031-71.52-17.505-97.289-9.684-4.138 1.255-8.514-1.081-9.768-5.219-1.254-4.14 1.08-8.513 5.221-9.771 29.581-8.98 78.756-7.245 109.83 11.202 3.722 2.209 4.943 7.016 2.737 10.733-2.2 3.722-7.02 4.949-10.73 2.739z"</span>/&gt;</span><span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"m232.09 78.586c-14.459-3.448-17.033-5.868-17.033-10.953 0-4.804 4.523-8.037 11.249-8.037 6.52 0 12.985 2.455 19.763 7.509 0.205 0.153 0.462 0.214 0.715 0.174 0.253-0.038 0.477-0.177 0.625-0.386l7.06-9.952c0.29-0.41 0.211-0.975-0.18-1.288-8.067-6.473-17.151-9.62-27.769-9.62-15.612 0-26.517 9.369-26.517 22.774 0 14.375 9.407 19.465 25.663 23.394 13.836 3.187 16.171 5.857 16.171 10.63 0 5.289-4.722 8.577-12.321 8.577-8.44 0-15.324-2.843-23.025-9.512-0.191-0.165-0.453-0.24-0.695-0.226-0.255 0.021-0.488 0.139-0.65 0.334l-7.916 9.421c-0.332 0.391-0.29 0.975 0.094 1.313 8.96 7.999 19.98 12.224 31.872 12.224 16.823 0 27.694-9.192 27.694-23.419 0.03-12.01-7.16-18.66-24.77-22.944z"</span>/&gt;</span><span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"m294.95 64.326c-7.292 0-13.273 2.872-18.205 8.757v-6.624c0-0.523-0.424-0.949-0.946-0.949h-12.947c-0.523 0-0.946 0.426-0.946 0.949v73.602c0 0.523 0.423 0.949 0.946 0.949h12.947c0.522 0 0.946-0.426 0.946-0.949v-23.233c4.933 5.536 10.915 8.241 18.205 8.241 13.549 0 27.265-10.43 27.265-30.368 0.02-19.943-13.7-30.376-27.25-30.376zm12.21 30.375c0 10.153-6.254 17.238-15.209 17.238-8.853 0-15.531-7.407-15.531-17.238 0-9.83 6.678-17.238 15.531-17.238 8.81-0.001 15.21 7.247 15.21 17.237z"</span>/&gt;</span><span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"m357.37 64.326c-17.449 0-31.119 13.436-31.119 30.592 0 16.969 13.576 30.264 30.905 30.264 17.511 0 31.223-13.391 31.223-30.481 0-17.031-13.62-30.373-31.01-30.373zm0 47.714c-9.281 0-16.278-7.457-16.278-17.344 0-9.929 6.755-17.134 16.064-17.134 9.341 0 16.385 7.457 16.385 17.351 0 9.927-6.8 17.127-16.17 17.127z"</span>/&gt;</span><span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"m425.64 65.51h-14.247v-14.566c0-0.522-0.422-0.948-0.945-0.948h-12.945c-0.524 0-0.949 0.426-0.949 0.948v14.566h-6.225c-0.521 0-0.943 0.426-0.943 0.949v11.127c0 0.522 0.422 0.949 0.943 0.949h6.225v28.791c0 11.635 5.791 17.534 17.212 17.534 4.644 0 8.497-0.959 12.128-3.018 0.295-0.165 0.478-0.483 0.478-0.821v-10.596c0-0.327-0.17-0.636-0.45-0.807-0.282-0.177-0.633-0.186-0.922-0.043-2.494 1.255-4.905 1.834-7.6 1.834-4.154 0-6.007-1.886-6.007-6.113v-26.756h14.247c0.523 0 0.944-0.426 0.944-0.949v-11.126c0.02-0.523-0.4-0.949-0.93-0.949z"</span>/&gt;</span><span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"m475.28 65.567v-1.789c0-5.263 2.018-7.61 6.544-7.61 2.699 0 4.867 0.536 7.295 1.346 0.299 0.094 0.611 0.047 0.854-0.132 0.25-0.179 0.391-0.466 0.391-0.77v-10.91c0-0.417-0.268-0.786-0.67-0.909-2.565-0.763-5.847-1.546-10.761-1.546-11.958 0-18.279 6.734-18.279 19.467v2.74h-6.22c-0.522 0-0.95 0.426-0.95 0.948v11.184c0 0.522 0.428 0.949 0.95 0.949h6.22v44.409c0 0.523 0.422 0.949 0.944 0.949h12.947c0.523 0 0.949-0.426 0.949-0.949v-44.406h12.088l18.517 44.398c-2.102 4.665-4.169 5.593-6.991 5.593-2.281 0-4.683-0.681-7.139-2.025-0.231-0.127-0.505-0.148-0.754-0.071-0.247 0.087-0.455 0.271-0.56 0.511l-4.388 9.627c-0.209 0.455-0.03 0.989 0.408 1.225 4.581 2.481 8.716 3.54 13.827 3.54 9.56 0 14.844-4.453 19.502-16.433l22.461-58.04c0.113-0.292 0.079-0.622-0.1-0.881-0.178-0.257-0.465-0.412-0.779-0.412h-13.478c-0.404 0-0.765 0.257-0.897 0.636l-13.807 39.438-15.123-39.464c-0.138-0.367-0.492-0.61-0.884-0.61h-22.12z"</span>/&gt;</span><span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"m446.5 65.51h-12.947c-0.523 0-0.949 0.426-0.949 0.949v56.485c0 0.523 0.426 0.949 0.949 0.949h12.947c0.522 0 0.949-0.426 0.949-0.949v-56.481c0-0.523-0.42-0.949-0.95-0.949z"</span>/&gt;</span><span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"m440.1 39.791c-5.129 0-9.291 4.152-9.291 9.281 0 5.132 4.163 9.289 9.291 9.289 5.127 0 9.285-4.157 9.285-9.289 0-5.128-4.16-9.281-9.28-9.281z"</span>/&gt;</span><span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"m553.52 83.671c-5.124 0-9.111-4.115-9.111-9.112s4.039-9.159 9.159-9.159c5.124 0 9.111 4.114 9.111 9.107 0 4.997-4.04 9.164-9.16 9.164zm0.05-17.365c-4.667 0-8.198 3.71-8.198 8.253 0 4.541 3.506 8.201 8.151 8.201 4.666 0 8.201-3.707 8.201-8.253 0-4.541-3.51-8.201-8.15-8.201zm2.02 9.138l2.577 3.608h-2.173l-2.32-3.31h-1.995v3.31h-1.819v-9.564h4.265c2.222 0 3.683 1.137 3.683 3.051 0.01 1.568-0.9 2.526-2.21 2.905zm-1.54-4.315h-2.372v3.025h2.372c1.184 0 1.891-0.579 1.891-1.514 0-0.984-0.71-1.511-1.89-1.511z"</span>/&gt;</span><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></div></pre></td></tr></table></figure><p>Optimised:</p><figure class="highlight html"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">width</span>=<span class="string">"1134"</span> <span class="attr">height</span>=<span class="string">"340"</span>&gt;</span><span class="tag">&lt;<span class="name">path</span> <span class="attr">fill</span>=<span class="string">"%23fff"</span> <span class="attr">d</span>=<span class="string">"M8 171c0 92 76 168 168 168s168-76 168-168S268 4 176 4 8 79 8 171zm230 78c-39-24-89-30-147-17-14 2-16-18-4-20 64-15 118-8 162 19 11 7 0 24-11 18zm17-45c-45-28-114-36-167-20-17 5-23-21-7-25 61-18 136-9 188 23 14 9 0 31-14 22zM80 133c-17 6-28-23-9-30 59-18 159-15 221 22 17 9 1 37-17 27-54-32-144-35-195-19zm379 91c-17 0-33-6-47-20-1 0-1 1-1 1l-16 19c-1 1-1 2 0 3 18 16 40 24 64 24 34 0 55-19 55-47 0-24-15-37-50-46-29-7-34-12-34-22s10-16 23-16 25 5 39 15c0 0 1 1 2 1s1-1 1-1l14-20c1-1 1-1 0-2-16-13-35-20-56-20-31 0-53 19-53 46 0 29 20 38 52 46 28 6 32 12 32 22 0 11-10 17-25 17zm95-77v-13c0-1-1-2-2-2h-26c-1 0-2 1-2 2v147c0 1 1 2 2 2h26c1 0 2-1 2-2v-46c10 11 21 16 36 16 27 0 54-21 54-61s-27-60-54-60c-15 0-26 5-36 17zm30 78c-18 0-31-15-31-35s13-34 31-34 30 14 30 34-12 35-30 35zm68-34c0 34 27 60 62 60s62-27 62-61-26-60-61-60-63 27-63 61zm30-1c0-20 13-34 32-34s33 15 33 35-13 34-32 34-33-15-33-35zm140-58v-29c0-1 0-2-1-2h-26c-1 0-2 1-2 2v29h-13c-1 0-2 1-2 2v22c0 1 1 2 2 2h13v58c0 23 11 35 34 35 9 0 18-2 25-6 1 0 1-1 1-2v-21c0-1 0-2-1-2h-2c-5 3-11 4-16 4-8 0-12-4-12-12v-54h30c1 0 2-1 2-2v-22c0-1-1-2-2-2h-30zm129-3c0-11 4-15 13-15 5 0 10 0 15 2h1s1-1 1-2V93c0-1 0-2-1-2-5-2-12-3-22-3-24 0-36 14-36 39v5h-13c-1 0-2 1-2 2v22c0 1 1 2 2 2h13v89c0 1 1 2 2 2h26c1 0 1-1 1-2v-89h25l37 89c-4 9-8 11-14 11-5 0-10-1-15-4h-1l-1 1-9 19c0 1 0 3 1 3 9 5 17 7 27 7 19 0 30-9 39-33l45-116v-2c0-1-1-1-2-1h-27c-1 0-1 1-1 2l-28 78-30-78c0-1-1-2-2-2h-44v-3zm-83 3c-1 0-2 1-2 2v113c0 1 1 2 2 2h26c1 0 1-1 1-2V134c0-1 0-2-1-2h-26zm-6-33c0 10 9 19 19 19s18-9 18-19-8-18-18-18-19 8-19 18zm245 69c10 0 19-8 19-18s-9-18-19-18-18 8-18 18 8 18 18 18zm0-34c9 0 17 7 17 16s-8 16-17 16-16-7-16-16 7-16 16-16zm4 18c3-1 5-3 5-6 0-4-4-6-8-6h-8v19h4v-6h4l4 6h5zm-3-9c2 0 4 1 4 3s-2 3-4 3h-4v-6h4z"</span>/&gt;</span><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></div></pre></td></tr></table></figure><p>You can see how the multiple <code>&lt;path /&gt;</code>s have been merged into one and the values are now integers.</p><p>In this pen I have included both the original and the optimised logo:</p><p></p><p data-height="367" data-theme-id="0" data-slug-hash="BjYaKg" data-default-tab="result" data-user="jmperez" class="codepen">See the Pen <a href="http://codepen.io/jmperez/pen/BjYaKg/" target="_blank" rel="external">Optimising Spotify SVG</a> by José Manuel Pérez (<a href="http://codepen.io/jmperez" target="_blank" rel="external">@jmperez</a>) on <a href="http://codepen.io" target="_blank" rel="external">CodePen</a>.</p><script async src="//assets.codepen.io/assets/embed/ei.js"></script>]]></content>
    
    <summary type="html">
    
      How to optimise your SVGs rounding values and using SVGOMG
    
    </summary>
    
    
      <category term="svg" scheme="https://jmperezperez.com/tags/svg/"/>
    
  </entry>
  
  <entry>
    <title>Drawing images using edge detection and SVG animation</title>
    <link href="https://jmperezperez.com/drawing-edges-svg/"/>
    <id>https://jmperezperez.com/drawing-edges-svg/</id>
    <published>2015-12-18T08:42:00.000Z</published>
    <updated>2016-11-21T08:16:16.000Z</updated>
    
    <content type="html"><![CDATA[<p>Back in the days SVG was barely used and supported. Some time after we started using them as an alternative to classic bitmaps for some icons, and finally we discovered it was the holy grail for providing responsive graphics. The flat and clean design trends have also make SVG as a very useful image format.</p><p>But SVG allows for even cooler features, thanks to the ability of modifying it using CSS and JS. And with some clever techniques we can make fun things, like <em>drawing</em> the borders of an image.</p><a id="more"></a><p>If you are like me and like to see the final result before going through a wall of text, here is a video that shows the result of applying this effect to a couple of images:</p><video controls style="max-width:100%" width="718" height="756"><source src="/assets/images/posts/contour.mp4" type="video/mp4"></video><h2 id="Animate-SVGs-to-achieve-a-drawing-effect"><a href="#Animate-SVGs-to-achieve-a-drawing-effect" class="headerlink" title="Animate SVGs to achieve a drawing effect"></a>Animate SVGs to achieve a <em>drawing</em> effect</h2><p>One of the applications I like is path animation. This draws slowly the lines that compose the SVG. If you don’t know what this is about, please check <a href="http://www.polygon.com/a/ps4-review" target="_blank" rel="external">Polygon’s reviews for PS4</a> and <a href="http://www.polygon.com/a/xbox-one-review" target="_blank" rel="external">Xbox One</a>. The effect is achieved by applying transitions to the <code>stroke-dashoffset</code> of SVG polylines.</p><p>Some time ago I played with <a href="https://github.com/JMPerez/spotify-logo-svg-drawing-animation" target="_blank" rel="external">this technique and the vector version of the Spotify logo</a>:</p><p></p><p data-height="403" data-theme-id="0" data-slug-hash="rxxRRg" data-default-tab="result" data-user="jmperez" class="codepen">See the Pen <a href="http://codepen.io/jmperez/pen/rxxRRg/" target="_blank" rel="external">Drawing SVGs - Spotify Logo</a> by José Manuel Pérez (<a href="http://codepen.io/jmperez" target="_blank" rel="external">@jmperez</a>) on <a href="http://codepen.io" target="_blank" rel="external">CodePen</a>.</p><script async src="//assets.codepen.io/assets/embed/ei.js"></script><p>This was based on <a href="http://codepen.io/derekjp/pen/KIGFe/" target="_blank" rel="external">the SVG Animation (Polygon.com PS4 Review) pen by Derek Palladino</a>, who reproduced Polygon’s drawings.</p><h2 id="Applying-the-technique-to-bitmap-images"><a href="#Applying-the-technique-to-bitmap-images" class="headerlink" title="Applying the technique to bitmap images"></a>Applying the technique to bitmap images</h2><p>Then one day I started thinking of drawing the contours of bitmap images. I would detect the contours of an image using canvas, and then I would create segments of adjacent points. As expected, some smart people have already worked on these things before, and I pretty much just had to put it together.</p><p>That’s how I created Contour. The project is <a href="https://github.com/JMPerez/contour" target="_blank" rel="external">on GitHub</a>, so feel free to clone it and tweak it. And if you want to try it out right now, I have embedded it right here:</p><iframe src="https://jmperezperez.com/contour/" width="100%" height="500"></iframe><p>You can drag and drop any image. It will work better with images with areas with high contrast.</p><p>You may wonder how this works, who doesn’t?</p><h3 id="Canvas"><a href="#Canvas" class="headerlink" title="Canvas"></a>Canvas</h3><p>First, the image that you drop is drawn into a canvas that has a maximum size. If the image exceeds that size, it is downscaled. This allows us to process larger images without making the browser become super slow. The smallest the canvas, the fastest, but also the less accurate would be the SVG lines.</p><p>Then, there is the core process: detecting edges and creating SVG lines out of them.</p><h3 id="Canny-edge-detector"><a href="#Canny-edge-detector" class="headerlink" title="Canny edge detector"></a>Canny edge detector</h3><p>I read about the <a href="https://en.wikipedia.org/wiki/Canny_edge_detector" target="_blank" rel="external">Canny edge detector</a> trying to find an algorithm that detected the edges from an image, and then found a JS implementation. <a href="https://github.com/yuta1984/CannyJS" target="_blank" rel="external">Canny JS</a> is one of them, and performs well. However, in the end I chose <a href="https://github.com/cmisenas/canny-edge-detection" target="_blank" rel="external">Jade Misenas’s project</a> because I could visualise better the steps of the algorithm and it resulted in longer lines with fewer gaps. This is important, since we need to be able to generate SVG lines by following the pixels that are part of the edge.</p><p>By the way, if you want to learn more about edge detection, I recommend you to have a look at <a href="https://www.youtube.com/watch?v=uihBwtPIBxM" target="_blank" rel="external">the video Finding the Edges (Sobel Operator)</a>, that explains one of the operators that can be used when performing edge detection.</p><h3 id="Tracing-the-edge"><a href="#Tracing-the-edge" class="headerlink" title="Tracing the edge"></a>Tracing the edge</h3><p>To obtain the SVG lines I used <a href="https://github.com/Doodle3D/Contour-finding-experiment" target="_blank" rel="external">Doodle3D’s Contour finding experiment</a>, which I eventually simplified a bit. The idea is to traverse the canvas and, once we find a white pixel (edge), we follow the nearby pixels to compose the line.</p><p>One we have a set of lines, we create one SVG polyline per contour, using the pixels as points. There are some improvements we can do here:</p><ul><li><p>Simplify polyline to remove points that don’t contribute to the line, that is, they can fall behind a longer segment. An example is having a horizontal line spanning through several pixels, that can be defined by 2 points instead of a line with 1 point per pixel. Doing this saves potentially lots of points, especially if there are lots of vertical or horizontal lines.</p></li><li><p>Smooth the polyline to match better arcs or diagonal lines that produce a stairstep-like line. In the project this is achieved by using half of the points to draw the image. The result is not that close to the border, but helps reducing those stairstep-like lines.</p></li><li><p>Use web workers to do the detection of the contour. This would prevent the browser from freezing for a few milliseconds.</p></li></ul><h2 id="Applications"><a href="#Applications" class="headerlink" title="Applications"></a>Applications</h2><p>The effect is cool by itself and doesn’t take long to compute. The browser needs the image to create the SVG lines, but this could be stored somewhere and be served as inlined SVG or a standalone SVG file. And doing this we suddenly have found a way to start <em>rendering</em> an image without having downloaded it yet. Also, note that SVG is highly compressible and we have full control of how many lines and points we want to use to represent the image.</p><p>If you have been following this blog, I have been talking lately about techniques to load images in a progressive way, with the <a href="/medium-image-progressive-loading-placeholder/"><em>blur up</em> technique used by Medium</a> and the use of <a href="/webp-placeholder-images/">WebP as placeholders</a>.</p><p>So I see this drawing effect as not only a fun thing to do with images, but also a way to provide a <em>placeholder</em> while the final image is downloaded.</p>]]></content>
    
    <summary type="html">
    
      Using SVGs to achieve a cool drawing effect
    
    </summary>
    
    
      <category term="images" scheme="https://jmperezperez.com/tags/images/"/>
    
      <category term="ux" scheme="https://jmperezperez.com/tags/ux/"/>
    
  </entry>
  
  <entry>
    <title>Farewell Rdio</title>
    <link href="https://jmperezperez.com/farewell-rdio/"/>
    <id>https://jmperezperez.com/farewell-rdio/</id>
    <published>2015-12-16T17:26:00.000Z</published>
    <updated>2016-11-21T08:16:20.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://blog.rdio.com/us/2015/11/important-news-from-rdio.html" target="_blank" rel="external">The news about Rdio shutting down</a> have been unexpected. It’s always sad when a company building great products closes down. And even though I am working at Spotify, I still want to see good competitors, both smaller and bigger, that make everyone else strive for improving. All in the benefit of users.</p><a id="more"></a><p>Those of us who work with the web are thankful to the existence of multiple browsers, that have result in a healthy race for implementing more features and delivering better performance, pushing the web forward.</p><p>Rdio had a snappy and beautiful clean web player that I envied, a <a href="http://www.rdio.com/developers/docs/web-playback/overview" target="_blank" rel="external">web playback API</a> that allowed lots of nice integrations, and a very complete <a href="http://www.rdio.com/developers/docs/web-service/index/" target="_blank" rel="external">REST API</a> that returned information like song play count, blurry background image and dominant colour for cover arts, which not many other streaming services expose.</p><p>I think they have also done a good job communicating their closure. <a href="http://www.rdio.com/farewell/" target="_blank" rel="external">Their farewell page</a>, with a friendly language, nicely designed, showing a brief but to-the-point timeline, is a good reminder of some of the values of Rdio. Especial kudos also to <a href="http://www.rdio.com/farewell/instructions/" target="_blank" rel="external">the export instructions</a>, making it easy for users to keep their collection.</p><p>I guess, after all, good products not necessarily mean good business, and vice versa. Let’s hope the best for the people in Rdio in their new journey with Pandora.</p><div style="font-weight:100;text-align:center;padding: 1em;background-color: #008fd5;color:#fff">Goodbye … for now.</div>]]></content>
    
    <summary type="html">
    
      Some thoughts about Rdio closing down.
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Using WebP to create tiny preview images</title>
    <link href="https://jmperezperez.com/webp-placeholder-images/"/>
    <id>https://jmperezperez.com/webp-placeholder-images/</id>
    <published>2015-11-28T10:30:00.000Z</published>
    <updated>2016-11-21T08:14:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>Following with the image optimization topic, I am going to have a deeper look to <a href="https://code.facebook.com/posts/991252547593574/the-technology-behind-preview-photos/" target="_blank" rel="external">Facebook’s technique to create <em>preview</em> photos</a>, and will show how WebP can simplify their solution.</p><p><img src="/assets/images/posts/webp-vs-jpeg-preview-photos.jpg" alt="WebP vs JPEG when encoding tiny images"></p><p><strong>tl;dr</strong> WebP produces tiny files when compressing small images. This makes it ideal for implementing <em>preview photos</em>. <a href="/demos/webp-preview/">Check the demo</a>.</p><a id="more"></a><p>In a recent article I talked about <a href="/medium-image-progressive-loading-placeholder/">an image loading technique used by Medium</a> that combined a small blurry preview plus a transition to the final image. This approach has been used for some time by other sites and mobile applications, and it is getting even more focus these days as major websites try to expand in countries with very slow internet connections.</p><p>Facebook is one of them and explained some months ago <a href="https://code.facebook.com/posts/991252547593574/the-technology-behind-preview-photos/" target="_blank" rel="external">how they inlined preview photos</a>.</p><h2 id="Finding-out-the-right-image-dimensions"><a href="#Finding-out-the-right-image-dimensions" class="headerlink" title="Finding out the right image dimensions"></a>Finding out the right image dimensions</h2><p>There is a direct relation between the dimensions of the image, its size in bytes, and the radius for the blur effect that needs to be applied to smooth the big upscaled pixels. In addition, we need to take into account the rendered dimensions of the image: we will want a larger preview the larger the rendered size is.</p><p>Facebook found that, for their mobile client, the sweet spot for the preview size was 42×42px. Then, they tried to generate the smallest (in bytes) image that they could serve with those dimensions. JPEG was the winning format, and they worked on reducing the file size even further by making the mobile client prepend a common header image and only transmit the basic image data.</p><h2 id="Taking-this-approach-to-the-web"><a href="#Taking-this-approach-to-the-web" class="headerlink" title="Taking this approach to the web"></a>Taking this approach to the web</h2><p>If we want to use the same technique on a website, we need to:</p><ol><li>Send image data.</li><li>Send the header.</li><li>Send the JS code that will glue the header and the data together.</li></ol><p>In the case of a mobile app, the code for (2) and (3) is shipped as part of the app. But in a website we need to send it as part of the response. This means that, at least the first time the user visits our page, there won’t be large savings using this technique. For subsequent requests, we could use cached JS or a Service Worker to do the glueing process.</p><p>But not everything is lost.</p><h2 id="Using-a-different-image-format"><a href="#Using-a-different-image-format" class="headerlink" title="Using a different image format"></a>Using a different image format</h2><p>I wondered how other format files performed in file size when saving small files. I tried with PNG and GIF, and both of them were larger than JPG. Then I have it a try to WebP and I was surprised on how well it compresses images.</p><h3 id="How-I-resized-and-compressed-the-images"><a href="#How-I-resized-and-compressed-the-images" class="headerlink" title="How I resized and compressed the images"></a>How I resized and compressed the images</h3><p><strong><a href="/demos/webp-preview/">In this page</a> you can see the demo and all the source images generated</strong></p><p>First, I downloaded some 64×64px cover art images using the <a href="https://developer.spotify.com/web-api/console/get-artist-albums/?id=61C3cEhdoJ9YiQSQSwYB4K" target="_blank" rel="external">Spotify Web API</a>. I wanted to use square images with a consistent small size.</p><p>Then I used Photoshop to create a 42×42px JPEG version of the files, with the minimum quality settings (that is, max compression). Then I passed them through <a href="https://imageoptim.com/" target="_blank" rel="external">ImageOptim</a>, that saved around 66% of the file size using a lossless optimization. The final average file size is 478 bytes. <a href="/assets/images/posts/imageoptim-jpg-optimization.png"><img src="/assets/images/posts/imageoptim-jpg-optimization.png" alt="ImageOptim squeezing JPGs"></a></p><p>Note that Facebook don’t mention what the size for their images was:</p><blockquote><p>“Unfortunately, the standard JPEG header is hundreds of bytes in size. In fact, the JPEG header alone is several times bigger than our entire 200-byte budget. However, excluding the JPEG header, the encoded data payload itself was approaching our 200 bytes” - taken from <a href="https://code.facebook.com/posts/991252547593574/the-technology-behind-preview-photos/" target="_blank" rel="external">The technology behind preview photos</a>.</p></blockquote><p>For the WebP version I used Photoshop to create a 42×42 px JPEG version of the files, but this time with the maximum quality settings. This is to make sure that I didn’t introduce artifacts that WebP had to encode. Then again, I passed the files through ImageOptim, reducing the file size around 25%, to an average of 2.5kB.</p><p>Finally, I run <a href="https://developers.google.com/speed/webp/docs/using" target="_blank" rel="external"><code>cwebp</code></a> to generate WebP images from the JPEG version, with the minimum quality:</p><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="keyword">for</span> f <span class="keyword">in</span> *.jpg; <span class="keyword">do</span> cwebp -q 0 <span class="variable">$f</span> -o <span class="string">"<span class="variable">$(basename $f .jpg)</span>"</span>.webp; <span class="keyword">done</span></div></pre></td></tr></table></figure><p>The resulting WebP images have a file size between 90 and 202 bytes, with an average of 121 bytes. That is <strong>25% of an equivalent JPG image</strong>. <a href="/assets/images/posts/webp-vs-jpeg-preview-photos.jpg"><img src="/assets/images/posts/webp-vs-jpeg-preview-photos.jpg" alt="WebP vs JPEG encoding tiny placeholder images"></a></p><p>The artifacts generated by JPEG and WebP are quite different, but in any case, when smoothed using blur, they look almost identical: <a href="/assets/images/posts/webp-vs-jpeg-preview-photos-blur.jpg"><img src="/assets/images/posts/webp-vs-jpeg-preview-photos-blur.jpg" alt="WebP vs JPEG encoding tiny placeholder images after applying a small blur effect"></a></p><p>Remember that these images are always shown with a blur effect, to smooth artifacts and pixels.</p><h3 id="Medium’s-Progressive-Loading-Inlined-WebP"><a href="#Medium’s-Progressive-Loading-Inlined-WebP" class="headerlink" title="Medium’s Progressive Loading + Inlined WebP"></a>Medium’s Progressive Loading + Inlined WebP</h3><p>I have forked the CodePen I created on <a href="/medium-image-progressive-loading-placeholder/">How Medium does progressive image loading</a> to show how it works with WebP. You will need a browser that supports WebP to see the full effect. Otherwise, you can <a href="/assets/images/posts/webp-progressive-image-loading.mp4">watch this video</a> showing the effect.</p><p>I have resized the original image to a 42×28px thumbnail, converted to WebP and generated its Data URI:</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">data:image/webp;base64,UklGRnoAAABXRUJQVlA4IG4AAABQBQCdASoqABwAP/3+/3+/urWyMBVYA/A/iWIAAR7p/Y3etgh4KD8QqXEZj6waibITSIAA/cndnUz4/z4LEgByYUql75Cq/12W33KFIKQpc8L0Dt19C7NFXin0tKlxd70dzSF978msbuqLjDgAAA==</div></pre></td></tr></table></figure><p>That’s 199 characters. And this is the result:</p><p></p><p data-height="403" data-theme-id="0" data-slug-hash="QjeWVv" data-default-tab="result" data-user="jmperez" class="codepen">See the Pen <a href="http://codepen.io/jmperez/pen/QjeWVv/" target="_blank" rel="external">Medium loading image effect reproduced - WebP version</a> by José Manuel Pérez (<a href="http://codepen.io/jmperez" target="_blank" rel="external">@jmperez</a>) on <a href="http://codepen.io" target="_blank" rel="external">CodePen</a>.</p><script async src="//assets.codepen.io/assets/embed/ei.js"></script><p>You can see it better <a href="http://codepen.io/jmperez/full/QjeWVv/" target="_blank" rel="external">in full screen</a>. I recommend that you use network throttling and disable cache to notice the full animation.</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>We have managed to create a file within the 200 bytes budget without having to mess with the headers nor fancy low-level hacks. <em>Here’s when I wonder if it would be possible to strip the header of the WebP files and get even higher savings</em>.</p><p>For the web, <a href="http://caniuse.com/#feat=webp" target="_blank" rel="external">WebP can only be used in Chrome and Opera</a>, which limits its applicability in the real world. Interestingly for Facebook’s use case, WebP is supported on native mobile apps on <a href="https://github.com/carsonmcdonald/WebP-iOS-example" target="_blank" rel="external">iOS</a> and <a href="https://github.com/EverythingMe/webp-android" target="_blank" rel="external">Android</a>, so they could well use WebP as an alternative to their <em>technology</em>.</p>]]></content>
    
    <summary type="html">
    
      Following with the image optimization topic, I am going to have a deeper look to Facebook&#39;s technique to create preview photos, and will show how WebP can simplify their solution.
    
    </summary>
    
    
      <category term="images" scheme="https://jmperezperez.com/tags/images/"/>
    
      <category term="facebook" scheme="https://jmperezperez.com/tags/facebook/"/>
    
      <category term="ux" scheme="https://jmperezperez.com/tags/ux/"/>
    
      <category term="webp" scheme="https://jmperezperez.com/tags/webp/"/>
    
  </entry>
  
  <entry>
    <title>Web Performance talk in Stockholm - Internet Days</title>
    <link href="https://jmperezperez.com/internetdagarna-2015/"/>
    <id>https://jmperezperez.com/internetdagarna-2015/</id>
    <published>2015-11-23T18:00:00.000Z</published>
    <updated>2016-11-21T08:16:29.000Z</updated>
    
    <content type="html"><![CDATA[<p>Today I have had the chance of attending the <a href="https://internetdagarna.se/arkiv/2015/internetdagarna.se/index.html%3Fp=17396.html" target="_blank" rel="external">Faster than lightning track</a> of <a href="https://internetdagarna.se/arkiv/2015/internetdagarna.se/index.html" target="_blank" rel="external">Internetdagarna 2015</a>. There have been talks about web performance, and some broader topics like big data and UI, how data is important for large companies offering free services, and the need for public Governments to build compelling competitive services. <a href="https://www.youtube.com/watch?v=7G0Xz0JsiFg&amp;index=1&amp;list=PLtDs7N_g_eiZ5ag.e-xntFYydij0xSPL42" target="_blank" rel="external">The videos are already online</a>.<img src="/assets/images/posts/internetdagarna-logo.jpg" alt="The Heart logo @ Internetdagarna 2015"></p><a id="more"></a><h2 id="Internetdagarna"><a href="#Internetdagarna" class="headerlink" title="Internetdagarna"></a>Internetdagarna</h2><p>A couple of weeks ago I attended <a href="http://www.meetup.com/es/Stockholm-Web-Performance-Group/events/226316269/" target="_blank" rel="external">Monitoring web performance using Open Source tools and AMP</a> by the <a href="http://www.meetup.com/es/Stockholm-Web-Performance-Group/" target="_blank" rel="external">Stockholm Web Performance Group</a>. I was lucky and got a ticket at a raffle where they gave out a couple of tickets to Internetdagarna.</p><p>I have only attended the first of the two days of the conference. It has been very well organized, and the quality of the talks very high. Well, I pretty much every talk about web performance :) Also, I love their 8-bit theme and the <a href="https://www.youtube.com/watch?v=sQvgCPNtSGk#t=01h26m36s" target="_blank" rel="external">looping animations with the logo</a>. <a href="/assets/images/posts/internetdagarna-hall.jpg"><img src="/assets/images/posts/internetdagarna-hall.jpg" alt="Main room at Internetdagarna 2015"></a></p><h2 id="Talks"><a href="#Talks" class="headerlink" title="Talks"></a>Talks</h2><h3 id="High-Performance-Images-by-Tobias-Baldauf"><a href="#High-Performance-Images-by-Tobias-Baldauf" class="headerlink" title="High Performance Images, by Tobias Baldauf"></a>High Performance Images, by Tobias Baldauf</h3><p>Great talk! If you care about images, their size and format, please watch this. Instead of just explaining the typical tips about resizing and optimising images, Tobias focuses on formats and compression.</p><p>He goes through the history of formats, and the multiple formats that have tried to replace JPEG (WebP and JPEG-XR). Then, he goes back to JPEG demoing <a href="https://github.com/mozilla/mozjpeg" target="_blank" rel="external">mozjpeg</a> as an enhancement for encoding JPEGs. The question is “what quality to use?”</p><p>The answer is measuring image dissimilarity, to find out how much different is the compressed version compared to the original one. Good news: there is a tool for that, called <a href="https://github.com/pornel/dssim" target="_blank" rel="external">dssim</a>. Then, one can run a script that compresses an image with different values until it reaches a certain dissimilarity threshold, like <a href="https://github.com/technopagan/cjpeg-dssim" target="_blank" rel="external">Tobias’ cjpeg-dssim</a>.</p><p>Tobias goes beyond this, and explains <a href="https://github.com/technopagan/adept-jpg-compressor" target="_blank" rel="external">his Adept script</a>, based on the idea of using different compression levels for different areas of the image, aka adaptive JPEG compression. The script takes a long time, but it can be worth it for doing one-shot optimisations for important assets like a hero image. <a href="/assets/images/posts/internetdagarna-tobias-baldauf.jpg"><img src="/assets/images/posts/internetdagarna-tobias-baldauf.jpg" alt="Tobias Baldauf presenting in Internetdagarna 2015"></a> <em>&uarr; Tobias Baldauf about to talk about mozjpeg</em></p><p><a href="https://www.youtube.com/watch?v=j5sRzAOt4nE" target="_blank" rel="external">Video on Youtube</a></p><h3 id="Cheat-Sheet-To-A-Lean-Website-by-Barbara-Bermes"><a href="#Cheat-Sheet-To-A-Lean-Website-by-Barbara-Bermes" class="headerlink" title="Cheat Sheet To A Lean Website, by Barbara Bermes"></a>Cheat Sheet To A Lean Website, by Barbara Bermes</h3><p>Barbara talks about performance culture, and the need to feel empowered and encouraged to say “no” when implementing features or designs that affect performance.</p><p>This is something I have been hearing lately, especially around the ad-blocker and bloated sites topic. I wish all developers could feel free to discuss decisions that affect user’s experience.</p><p>And when it comes to performance culture, it’s almost impossible not to mention Etsy.</p><p>Barbara then goes through some good ideas, like having a performance budget, or defining mockups of the important areas that need to be rendered quickly, being aware of the critical rendering path, and the rest of Steve Souders’s principles. <a href="/assets/images/posts/internetdagarna-barbara-bermes.jpg"><img src="/assets/images/posts/internetdagarna-barbara-bermes.jpg" alt="Barbara Bermes presenting in Internetdagarna 2015"></a> <em>&uarr; Barbara Bermes talking about performance culture</em></p><p><a href="https://www.youtube.com/watch?v=QQZigZiQ9Gg" target="_blank" rel="external">Video on Youtube</a></p><h3 id="The-Case-for-HTTP-2-by-Andy-Davies"><a href="#The-Case-for-HTTP-2-by-Andy-Davies" class="headerlink" title="The Case for HTTP/2, by Andy Davies"></a>The Case for HTTP/2, by Andy Davies</h3><p>Andy explains the history of HTTP 1.1, its limitations and the workarounds we came up with to overcome its limitations. I find particularly interesting how inlining critical CSS in the HTML or inlining images in CSS using data URIs means that we are overriding browser’s priorities, based on heuristics to determine what resources should be downloaded first. I had never thought about it from this perspective.</p><p>But Andy doesn’t try to just sell HTTP/2. He explains HTTP/2 through some real examples applied to real sites. In some cases there is almost no improvement in loading time, and it is still difficult to implement a server push approach that takes into account whether the browser already has the filed being pushed. He also shows some issues in some server implementations that developers need to be aware of. <a href="/assets/images/posts/internetdagarna-andy-davies.jpg"><img src="/assets/images/posts/internetdagarna-andy-davies.jpg" alt="Andy Davies presenting in Internetdagarna 2015"></a> <em>&uarr; Andy Davies showing how to debug HTTP/2 connections with Chrome tools</em></p><p><a href="https://www.youtube.com/watch?v=m1b_VQk73SI" target="_blank" rel="external">Video on Youtube</a></p><h3 id="Working-with-performance-by-Tobias-J-228-rlund"><a href="#Working-with-performance-by-Tobias-J-228-rlund" class="headerlink" title="Working with performance, by Tobias J&#228;rlund"></a>Working with performance, by Tobias J&#228;rlund</h3><p>Tobias explains how Aftonbladet.se, the main news site in Sweden, approaches web performance, and what problems they have faced when trying to make everyone aware of the performance implications of the content (ads, large images…). <a href="/assets/images/posts/internetdagarna-tobias-jarlund.jpg"><img src="/assets/images/posts/internetdagarna-tobias-jarlund.jpg" alt="Tobias Järlund presenting in Internetdagarna 2015"></a> <em>&uarr; Tobias Järlund talking about blocking 3rd party content. I personally don’t like the quote depicted in that slide, since I think Aftonbladet’s most important content should be, of course, news.</em></p><p><em>No video available yet</em></p><h3 id="Baking-in-Performance-with-Agile-by-Meri-Williams"><a href="#Baking-in-Performance-with-Agile-by-Meri-Williams" class="headerlink" title="Baking in Performance with Agile, by Meri Williams"></a>Baking in Performance with Agile, by Meri Williams</h3><p>Meri goes through some ideas to implement performance culture within teams. Also, she encourages everyone to similar devices and network connections to those from real users browsing our site. This can also help out when taking into account performance in other teams within the company. <a href="/assets/images/posts/internetdagarna-meri-williams.jpg"><img src="/assets/images/posts/internetdagarna-meri-williams.jpg" alt="Meri Williams presenting in Internetdagarna 2015"></a> <em>&uarr; Meri Williams about unexpected events that can affect your traffic</em></p><p><em>No video available yet</em></p>]]></content>
    
    <summary type="html">
    
      Faster than lightning was a set of talks around web performance during Internetdagarna 2015 in Stockholm, Sweden
    
    </summary>
    
    
      <category term="conference" scheme="https://jmperezperez.com/tags/conference/"/>
    
  </entry>
  
  <entry>
    <title>How Medium does progressive image loading</title>
    <link href="https://jmperezperez.com/medium-image-progressive-loading-placeholder/"/>
    <id>https://jmperezperez.com/medium-image-progressive-loading-placeholder/</id>
    <published>2015-10-18T20:05:00.000Z</published>
    <updated>2016-11-21T08:16:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>Recently, I was browsing a post on Medium and I spotted a nice image loading effect. First, load a small blurry image, and then transition to the large image. I found it pretty neat and wanted to dissect how it was done.</p><p><img src="/assets/images/posts/medium-placeholder.png" alt="A screenshot of a blurry placeholder while the image is loaded"></p><a id="more"></a><h2 id="Medium’s-technique"><a href="#Medium’s-technique" class="headerlink" title="Medium’s technique"></a>Medium’s technique</h2><p>To see how image loading works in Medium, it is best to see a demo:</p><video controls style="max-width:100%" width="854" height="480"><source src="/assets/images/posts/medium-progressive-loading.mp4" type="video/mp4"></video><p>I have performed a <a href="http://www.webpagetest.org/video/compare.php?tests=151018_XD_KDF-r:1-c:0" target="_blank" rel="external">WebPageTest test</a> against <a href="https://medium.com/backchannel/exclusive-why-apple-is-still-sweating-the-details-on-imac-531a95e50c91" target="_blank" rel="external">this page on Medium</a> where you can see how it loads too. And if you want to see it by yourself, open Medium’s post in your browser, disable the cache and throttle the response so it takes longer to fetch the images and you can see the effect.</p><p>Here is what is going on:</p><ol><li><p><strong>Render a div where the image will be displayed</strong>. Medium uses a <code>&lt;div/&gt;</code> with a <code>padding-bottom</code> set to a percentage, which corresponds to the aspect ratio of the image. Thus, they prevent reflows while the images are loaded since everything is rendered in its final position. This has also been referred to as <a href="http://daverupert.com/2015/12/intrinsic-placeholders-with-picture/" target="_blank" rel="external">intrinsic placeholders</a>.</p></li><li><p><strong>Load a tiny version of the image</strong>. At the moment, they seem to be requesting small JPEG thumbnails with a very low quality (e.g. 20%). The markup for this small image is returned in the initial HTML as an <code>&lt;img/&gt;</code>, so the browser starts fetching them right away.</p></li><li><p>Once the image is loaded, <strong>it is drawn in a <code>&lt;canvas/&gt;</code></strong>. Then, the image data is taken and passed through a custom <code>blur()</code> function You can see it, a bit scrambled, in the <code>main-base.bundle</code> JS file. This function is similar, though not identical, to <a href="http://www.quasimondo.com/StackBlurForCanvas/StackBlurDemo.html" target="_blank" rel="external">StackBlur</a>‘s blur function. At the same time, <strong>the main image is requested</strong>.</p></li><li><p>Once the main image is loaded, <strong>it is shown</strong> and the <code>canvas</code> is hidden.</p></li></ol><p>All the transitions are quite smooth, thanks to the CSS animations applied.</p><h2 id="Markup"><a href="#Markup" class="headerlink" title="Markup"></a>Markup</h2><p>A bird’s eye view of the markup for an image:</p><figure class="highlight html"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">figure</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span>/&gt;</span> <span class="comment">&lt;!-- this div keeps the aspect ratio so the placeholder doesn't collapse --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">img</span>/&gt;</span> <span class="comment">&lt;!-- this is a tiny image with a resolution of e.g. ~27x17 and low quality --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">canvas</span>/&gt;</span> <span class="comment">&lt;!-- takes the above image and applies a blur filter --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">img</span>/&gt;</span> <span class="comment">&lt;!-- the large image to be displayed --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">noscript</span>/&gt;</span> <span class="comment">&lt;!-- fallback for no JS --&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">figure</span>&gt;</span></div></pre></td></tr></table></figure><p>And a concrete example, so you see what goes in those tags:</p><figure class="highlight html"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">figure</span> <span class="attr">name</span>=<span class="string">"7012"</span> <span class="attr">id</span>=<span class="string">"7012"</span> <span class="attr">class</span>=<span class="string">"graf--figure graf--layoutFillWidth graf-after--h4"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"aspectRatioPlaceholder is-locked"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"aspect-ratio-fill"</span> <span class="attr">style</span>=<span class="string">"padding-bottom: 66.7%;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"progressiveMedia js-progressiveMedia graf-image is-canvasLoaded is-imageLoaded"</span> <span class="attr">data-image-id</span>=<span class="string">"1*sg-uLNm73whmdOgKlrQdZA.jpeg"</span> <span class="attr">data-width</span>=<span class="string">"2000"</span> <span class="attr">data-height</span>=<span class="string">"1333"</span> <span class="attr">data-scroll</span>=<span class="string">"native"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"https://cdn-images-1.medium.com/freeze/max/27/1*sg-uLNm73whmdOgKlrQdZA.jpeg?q=20"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span> <span class="attr">class</span>=<span class="string">"progressiveMedia-thumbnail js-progressiveMedia-thumbnail"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">class</span>=<span class="string">"progressiveMedia-canvas js-progressiveMedia-canvas"</span> <span class="attr">width</span>=<span class="string">"75"</span> <span class="attr">height</span>=<span class="string">"47"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"progressiveMedia-image js-progressiveMedia-image __web-inspector-hide-shortcut__"</span> <span class="attr">data-src</span>=<span class="string">"https://cdn-images-1.medium.com/max/1800/1*sg-uLNm73whmdOgKlrQdZA.jpeg"</span> <span class="attr">src</span>=<span class="string">"https://cdn-images-1.medium.com/max/1800/1*sg-uLNm73whmdOgKlrQdZA.jpeg"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">noscript</span> <span class="attr">class</span>=<span class="string">"js-progressiveMedia-inner"</span>&gt;</span>&amp;lt;img class="progressiveMedia-noscript js-progressiveMedia-inner" src="https://cdn-images-1.medium.com/max/1800/1*sg-uLNm73whmdOgKlrQdZA.jpeg"&amp;gt;<span class="tag">&lt;/<span class="name">noscript</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">figure</span>&gt;</span></div></pre></td></tr></table></figure><p><em>Note that the actual image sizes requested depend on the device.</em></p><h2 id="An-attempt-to-reproduce-the-effect"><a href="#An-attempt-to-reproduce-the-effect" class="headerlink" title="An attempt to reproduce the effect"></a>An attempt to reproduce the effect</h2><p>I have prepared <a href="http://codepen.io/jmperez/pen/yYjPER" target="_blank" rel="external">this CodePen</a> where I have implemented the same effect, though using CSS filters for the blur instead of a canvas (see below more info about this variant).</p><p>Here is a demo (click ‘Run Pen’ to run it):</p><p data-height="403" data-theme-id="0" data-slug-hash="yYjPER" data-default-tab="result" data-user="jmperez" class="codepen" data-preview="true">See the Pen <a href="http://codepen.io/jmperez/pen/yYjPER/" target="_blank" rel="external">Medium loading image effect reproduced</a> by José Manuel Pérez (<a href="http://codepen.io/jmperez" target="_blank" rel="external">@jmperez</a>) on <a href="http://codepen.io" target="_blank" rel="external">CodePen</a>.</p><p>You can see it better <a href="http://codepen.io/jmperez/full/Xmzobe/" target="_blank" rel="external">in full screen</a>. I recommend that you use network throttling and disable cache to notice the full animation.</p><p>This filmstrip view shows the above codepen when disabling cache and throttling to “Good 3G”: <img src="/assets/images/posts/medium-codepen.png" alt="Chrome Inspector Timeline Capture"></p><h2 id="Is-it-worth-it"><a href="#Is-it-worth-it" class="headerlink" title="Is it worth it?"></a>Is it worth it?</h2><p>Clearly, there is a lot of things going on to be able to render an image this way, and it can be discouraging to do something similar on your site. A few years ago it would have been impossible to do this animations and blur effects in a performant way, but the truth is that most of the times the latency is the bottleneck, not the device capabilities, and we can play with these visual explorations.</p><p>Having full control of the loading of images has some advantages:</p><ul><li><p><strong>Lazy loading</strong>. Using JS for making the requests allows them to be in control of what images are requested. While all the small thumbnails are requested, the large images are only requests when they are within the viewport.</p></li><li><p><strong>Better placeholder</strong>. The thumbnails are very small, barely 2kB, which combined with the blurry effect allows for a better placeholder than a solid colour, without sacrificing payload.</p></li><li><p><strong>Tailored image sizes</strong>. Medium serves different images sizes depending on the device that makes the requests, which optimises the weight of the page.</p></li></ul><h2 id="Variants"><a href="#Variants" class="headerlink" title="Variants"></a>Variants</h2><p>Before finding out about this technique, I thought of using a similar approach for a site I’m working on.</p><h3 id="Inlining-image-data"><a href="#Inlining-image-data" class="headerlink" title="Inlining image data"></a>Inlining image data</h3><p>Instead of making a request for the small thumbnails, it is possible to inline them using data URIs. This increases the size of the HTML, but accelerates the rendering of the placeholder, which is immediate one the markup is downloaded. The blur effect allows these images to be really small. I did some tests with 0.5kB size images, and the result was similar to using a 4x larger image.</p><h3 id="Blur-effect"><a href="#Blur-effect" class="headerlink" title="Blur effect"></a>Blur effect</h3><p>By default, when a browser renders a small image scaled up, it applies a light blur effect to smooth the artefacts of the image. The effect can also be <a href="http://superuser.com/questions/530317/how-to-prevent-chrome-from-blurring-small-images-when-zoomed-in" target="_blank" rel="external">turned off</a> for images like QR codes.</p><blockquote><p>[…]the browser would render it in a way that didn’t make it look blocky[…] from <a href="https://developers.google.com/web/updates/2015/01/pixelated" target="_blank" rel="external">Google Developers</a>.</p></blockquote><p>This works both in Chrome, Safari and Firefox (I haven’t tried on IE yet), though the smoothing effect is more prominent in Chrome. Here is a demo, but you can see it better <a href="http://codepen.io/jmperez/full/Xmzobe/" target="_blank" rel="external">in full screen</a>:</p><p data-height="367" data-theme-id="0" data-slug-hash="Xmzobe" data-default-tab="result" data-user="jmperez" class="codepen">See the Pen <a href="http://codepen.io/jmperez/pen/Xmzobe/" target="_blank" rel="external">Blur effect when scaling up a small image</a> by José Manuel Pérez (<a href="http://codepen.io/jmperez" target="_blank" rel="external">@jmperez</a>) on <a href="http://codepen.io" target="_blank" rel="external">CodePen</a>.</p><p>Note how the artefacts are smoothen. Keep in mind that the image is only 27px wide and has very low quality, which should result in an awful scaled-up version, but it isn’t. If the above effect is enough for you, then you don’t need to use more complicated alternatives.</p><p>The blur effect can also be achieved using <a href="http://codepen.io/aniketpant/pen/DsEve" target="_blank" rel="external">CSS Filter Effects</a>. <a href="http://caniuse.com/#feat=css-filters" target="_blank" rel="external">Its support is quite wide</a> aside from IE. I’m pretty sure Medium tried this before going to a canvas solution, which feels far too over-engineered, but for some reason they decided not to use it.</p><p></p><p data-height="367" data-theme-id="0" data-slug-hash="PPOXzY" data-default-tab="result" data-user="jmperez" class="codepen">See the Pen <a href="http://codepen.io/jmperez/pen/PPOXzY/" target="_blank" rel="external">Blur effect using CSS blur() filter on a small image</a> by José Manuel Pérez (<a href="http://codepen.io/jmperez" target="_blank" rel="external">@jmperez</a>) on <a href="http://codepen.io" target="_blank" rel="external">CodePen</a>.</p><script async src="//assets.codepen.io/assets/embed/ei.js"></script><p>The advantage of this technique is that you can easily tweak how much blur you want and everything is achieved using CSS.</p><p>Another option is to use a SVG filter, as explained in <a href="https://css-tricks.com/the-blur-up-technique-for-loading-background-images/" target="_blank" rel="external">The “Blur Up” Technique for Loading Background Images</a> and <a href="http://rentafounder.com/textured-gradients-in-pure-css/" target="_blank" rel="external">Textured Gradients in Pure CSS</a>.</p><h3 id="Other-ways-of-improving-placeholders-Google-Images-Search"><a href="#Other-ways-of-improving-placeholders-Google-Images-Search" class="headerlink" title="Other ways of improving placeholders: Google Images Search"></a>Other ways of improving placeholders: Google Images Search</h3><p>A simpler technique is used by Google Search when searching for images from a smartphone: <a href="{/assets/images/posts/google-images-placeholder.png"><img src="/assets/images/posts/google-images-placeholder.png" alt="Searching on Google Images from the phone"></a> <em>&uarr; Google Images Search shows a solid background as placeholder (left image is while loading, right when already loaded).</em></p><p>They pick a colour (maybe the dominant colour of the picture?) and they use it a solid colour background. It gives the user the feeling that images loads faster.</p><h3 id="An-even-more-advanced-one-Facebook’s-200-byte-technique"><a href="#An-even-more-advanced-one-Facebook’s-200-byte-technique" class="headerlink" title="An even more advanced one: Facebook’s 200 byte technique"></a>An even more advanced one: Facebook’s 200 byte technique</h3><p>Earlier this year Facebook posted “<a href="https://code.facebook.com/posts/991252547593574/the-technology-behind-preview-photos/" target="_blank" rel="external">The technology behind preview photos</a>“, an interesting article about serving 42 x 42px image previews without the JPEG header.</p><p>The scenario is a bit different, since these “images” are served to the Facebook mobile client, which knows how to prepend the header to compose a valid JPEG image. In the case of a website, we would need to compose this using Javascript, which would probably remove most of the savings. A solution would be to use a Service Worker to do the composition, though we would still need some Javascript to send a “request” with the image contents.</p><p>In any case, it seems a bit overkilling for the web, but I wanted to include it as a reference. <a href="/webp-placeholder-images/">Using WebP for generating this preview images</a> can lead to similar savings without having to resort to “creative” solutions.</p><h3 id="LQIP-Low-Quality-Image-Placeholders"><a href="#LQIP-Low-Quality-Image-Placeholders" class="headerlink" title="LQIP: Low Quality Image Placeholders"></a>LQIP: Low Quality Image Placeholders</h3><p>Instead of waiting for the final image to be rendered, we can serve a highly compressed image first, and then switch to the large one. This is what <a href="http://www.guypo.com/introducing-lqip-low-quality-image-placeholders/" target="_blank" rel="external">Low Quality Image Placeholders (LQIP)</a> consists of. The idea is similar to Medium’s, but serving an image with the same dimensions but higher compression.</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>As our pages load more and more images, it is good to think of their loading process on our pages, since it affects performance and user experience.</p><p>If you are generating several thumbnail sizes for your images, you can experiment using a very small one to use it as the background while the final image loads.</p><div class="read-next" style="padding:1em;background-color:#fdf6ea;margin:2rem 0"><strong>Interested in other image tips and tricks?</strong><br>Check out <a href="/image-optimization-lossy-lossless-techniques">Image optimization: Lossy, lossless and other techniques</a>.</div>]]></content>
    
    <summary type="html">
    
      This post explains how Medium renders an image placeholder using low-res thumbnails and canvas
    
    </summary>
    
    
      <category term="images" scheme="https://jmperezperez.com/tags/images/"/>
    
      <category term="ux" scheme="https://jmperezperez.com/tags/ux/"/>
    
  </entry>
  
  <entry>
    <title>Fronteers 2015 - A wrap up</title>
    <link href="https://jmperezperez.com/fronteers-2015/"/>
    <id>https://jmperezperez.com/fronteers-2015/</id>
    <published>2015-10-11T16:35:00.000Z</published>
    <updated>2016-11-21T08:16:44.000Z</updated>
    
    <content type="html"><![CDATA[<p>This was my first time in Fronteers, surrounded by lots of frontend developers and designers in an amazing venue in Amsterdam. Here I have a quick review of its talks.</p><p>The conference covered frontend development from several views. There were talks about interesting browser APIs, accessibility, developer tools, build tools, progressive enhancement, design guidelines, open data, how to structure teams or how to deal with projects and clients. It was very well organised, with good food, coffee and other snacks, as well as after-talk mingling.</p><a id="more"></a><p>You can find the <a href="https://vimeo.com/fronteers/videos" target="_blank" rel="external">Fronteers 2015 videos on Vimeo</a>, and <a href="http://lanyrd.com/2015/fronteersconf/" target="_blank" rel="external">the slides on Lanyrd</a>, which I collected from the speakers presentations and tweets.</p><h2 id="Things-I-learned"><a href="#Things-I-learned" class="headerlink" title="Things I learned"></a>Things I learned</h2><ul><li><p>I love <a href="https://www.filamentgroup.com/" target="_blank" rel="external">Filament Group</a>. I started following <a href="https://www.filamentgroup.com/lab/" target="_blank" rel="external">their blog</a> after coming across some of their posts focused on progressive enhancement and responsive design. They are great sharing real use cases and open sourcing their solutions. <a href="http://scottjehl.com/" target="_blank" rel="external">Scott Jehl</a> did a great talk about performance optimisation for all kind of assets (images, fonts, CSS, JS) and the future (almost present) HTTP 2.</p></li><li><p>UK is full of great agencies and people who care about the web. The guys from <a href="http://primate.co.uk/" target="_blank" rel="external">Primate</a> talked about how they started with their company and how they have dealt with projects and clients. It’s always great seeing talks about real experiences. <a href="http://maban.co.uk/" target="_blank" rel="external">Anna Debenham</a> talked about design guidelines and <a href="http://alicebartlett.co.uk/" target="_blank" rel="external">Alice Bartlett</a> about accessibility and her past work in Government Digital Service (part of gov.uk).</p><p>There is something especial in the UK, in how private and public companies are building websites in the right way and how well they share their findings. Take for instance <a href="http://responsivenews.co.uk/" target="_blank" rel="external">BBC and their Responsive News</a>, <a href="https://www.gov.uk/service-manual" target="_blank" rel="external">Gov.uk and their amazing guides on design, development and testing amongst others</a> and <a href="http://next.theguardian.com/" target="_blank" rel="external">The Guardian’s take on responsive web</a>. I can’t but regret not seeing similar efforts from other web sites.</p></li><li><p>Good speakers are even better in person. I have seen numerous recorded talks by Christian Heilmann and Jake Archibald, and seeing them right there is even better. They definitely excel at speaking and delivering their message, are really fun and true to their principles.</p></li></ul><h2 id="Sessions"><a href="#Sessions" class="headerlink" title="Sessions"></a>Sessions</h2><h3 id="Day-1-Thursday-8th-October-2015"><a href="#Day-1-Thursday-8th-October-2015" class="headerlink" title="Day 1 Thursday 8th October 2015"></a>Day 1 Thursday 8th October 2015</h3><h3 id="Delivering-Responsibly-by-Scott-Jehl"><a href="#Delivering-Responsibly-by-Scott-Jehl" class="headerlink" title="Delivering Responsibly, by Scott Jehl"></a>Delivering Responsibly, by Scott Jehl</h3><p>Very good talk about progressive enhancement, responsive design, resource delivering optimisation (HTTP2, Critical + async CSS, async JS, non blocking fonts, responsive images).</p><p>Scott works for Filament Group, and they post great articles about how these topics, as well as open source tools like polyfills for responsive images, async CSS loaders or custom font loaders.</p><p>He also talked about the content blockers that are becoming popular and how we, as developers, should not take for granted that certain resources will be loaded, having to develop defensively.</p><p><em>Update 2015-10-28: Scott has published a write-up about the presentation on <a href="https://www.filamentgroup.com/lab/delivering-responsibly.html" target="_blank" rel="external">Filament Group’s site</a>.</em></p><h3 id="Digital-Governance-by-Lisa-Welchman"><a href="#Digital-Governance-by-Lisa-Welchman" class="headerlink" title="Digital Governance, by Lisa Welchman"></a>Digital Governance, by Lisa Welchman</h3><p>This was the least technical talk, touching topics like team organization and communication.</p><h3 id="Lightning-Fast-Sass-by-Chris-Eppstein"><a href="#Lightning-Fast-Sass-by-Chris-Eppstein" class="headerlink" title="Lightning Fast Sass, by Chris Eppstein"></a>Lightning Fast Sass, by Chris Eppstein</h3><p>Chris talked about why and how they reimplemented the Sass library from Ruby to C (libSass). He went through the different modules that compose it and how to include them in your project.</p><p>Although useful, to me it looked over complicated and I wondered whether using these tools is worth it, or the stylesheets should be as simple and close to CSS as possible.</p><h3 id="Walking-the-tightrope-between-mediocrity-and-bankruptcy-by-Bartlomiej-Oleszczyk-Gordon-McLachlan-and-Espen-Brunborg"><a href="#Walking-the-tightrope-between-mediocrity-and-bankruptcy-by-Bartlomiej-Oleszczyk-Gordon-McLachlan-and-Espen-Brunborg" class="headerlink" title="Walking the tightrope between mediocrity and bankruptcy by Bartlomiej Oleszczyk, Gordon McLachlan and Espen Brunborg"></a>Walking the tightrope between mediocrity and bankruptcy by Bartlomiej Oleszczyk, Gordon McLachlan and Espen Brunborg</h3><p>Awesome talk! These guys work in Primate, a small agency from Edinburgh, and explained how they deal with clients and projects, trying to keep a good quality while surviving as a company.</p><p>It’s always good to see people telling about real stories and cases, instead of just some crazy library or prototype.</p><h3 id="jsmpeg-Why-a-Javascript-video-decoder-actually-makes-sense-by-Dominic-Szablewski"><a href="#jsmpeg-Why-a-Javascript-video-decoder-actually-makes-sense-by-Dominic-Szablewski" class="headerlink" title="jsmpeg: Why a Javascript video decoder actually makes sense, by Dominic Szablewski"></a>jsmpeg: Why a Javascript video decoder actually makes sense, by Dominic Szablewski</h3><p>Dominic built one of the first HTML5 games in 2010 (Biolab Disaster) and likes to hack porting Quake to the Oculus to be played on the browser, or play GTA V from the phone using a browser that decodes MPEG1 that comes is sent from a Windows application… well, <a href="http://phoboslab.org/log/2015/07/play-gta-v-in-your-browser-sort-of" target="_blank" rel="external">better see the demo</a>.</p><p>He explained how he had implemented an MPEG1 video decoder using Javascript, how the format works, what problems he found while implementing it and possible applications.</p><p>He blow everyone away. <a href="/assets/images/posts/fronteers-2015-phoboslab.jpg"><img src="/assets/images/posts/fronteers-2015-phoboslab.jpg" alt="Phoboslab presenting in Fronteers 2015"></a> <em>&uarr; Dominic Szablewski talking about how (and why) he built an MPEG1 Video Decoder in JavaScript</em></p><h3 id="Front-End-Style-Guides-by-Anna-Debenham"><a href="#Front-End-Style-Guides-by-Anna-Debenham" class="headerlink" title="Front-End Style Guides, by Anna Debenham"></a>Front-End Style Guides, by Anna Debenham</h3><p>Anna went through lots of frontend guidelines, both from public and private companies, and explained why all sites should have one, how one should start building it and some tips to prevent them from becoming out of sync.</p><h3 id="What-is-the-business-case-for-accessibility-by-Alice-Bartlett"><a href="#What-is-the-business-case-for-accessibility-by-Alice-Bartlett" class="headerlink" title="What is the business case for accessibility? by Alice Bartlett"></a>What is the business case for accessibility? by Alice Bartlett</h3><p>Alice has worked for gov.uk and explained why accessibility is important. In brief, users can sue websites in certain countries if the sites don’t offer a certain level of accessibility, and this is usually enough reason to take care about this. Also, by making a site more accessible there are some side advantages, like reaching more users, and improving a site’s image.</p><h3 id="Modern-Progressive-Enhancement-by-Jake-Archibald"><a href="#Modern-Progressive-Enhancement-by-Jake-Archibald" class="headerlink" title="Modern Progressive Enhancement, by Jake Archibald"></a>Modern Progressive Enhancement, by Jake Archibald</h3><p>You might have seen this one in Nordic.JS or Brazil.JS, and it’s really fun.</p><p>The topic of progressive enhancement has been covered for a long time, but it’s good to remind it from now and then, especially when we start using big JS frameworks to build upon our sites.</p><p>Jake talks about critical CSS and service workers as two ways of improving how our sites are delivered to users. <a href="/assets/images/posts/fronteers-2015-jake-archibald.jpg"><img src="/assets/images/posts/fronteers-2015-jake-archibald.jpg" alt="Jake Archibald presenting in Fronteers 2015"></a> <em>&uarr; Jake Archibald talking about Web Performance Optimization, Critical CSS and Service Workers</em></p><h2 id="Day-2-Friday-9th-October-2015"><a href="#Day-2-Friday-9th-October-2015" class="headerlink" title="Day 2 Friday 9th October 2015"></a>Day 2 Friday 9th October 2015</h2><h3 id="Static-Sites-Go-All-Hollywood-by-Phil-Hawksworth"><a href="#Static-Sites-Go-All-Hollywood-by-Phil-Hawksworth" class="headerlink" title="Static Sites Go All Hollywood, by Phil Hawksworth"></a>Static Sites Go All Hollywood, by Phil Hawksworth</h3><p>I’m personally a big fan of static sites, and it’s interesting to see a talk about them. Phil talks about some scenarios in which a static site makes completely sense, and how they can cope with a big amount of traffic.</p><p>He also talks about different strategies that can be followed to generate the content, and different tools and providers to host them.</p><h3 id="Modern-Workflow-Tooling-for-Front-end-Developers-by-Wes-Bos"><a href="#Modern-Workflow-Tooling-for-Front-end-Developers-by-Wes-Bos" class="headerlink" title="Modern Workflow + Tooling for Front-end Developers, by Wes Bos"></a>Modern Workflow + Tooling for Front-end Developers, by Wes Bos</h3><p>Wes explained why we need to have a build script in our projects.</p><p>Most of this talk was about tools and techniques that we are already familiar with. Grunt, Gulp or NPM as build systems, or bower, npm and jspm as dependency managers. CSS and JS minifiers, image optimizers… they usual suspects.</p><p>There was one tool I really liked and hadn’t used before: browsersync. It runs a local server with SSL integration and can be used to synchronize several devices screens (synchronizing scrolls, clicks and requests) and also to expose a server accessible from within the local network. Wes also went through some new features in ES6, and how these build systems allow us to use the new JS specifications today. <a href="/assets/images/posts/fronteers-2015-wes-bos.jpg"><img src="/assets/images/posts/fronteers-2015-wes-bos.jpg" alt="Wes Bos presenting in Fronteers 2015"></a> <em>&uarr; Wes Bos going through the myriad of dependency management systems and build tools for web projects</em></p><h3 id="An-Introduction-to-Open-Data-by-Sally-Jenkinson"><a href="#An-Introduction-to-Open-Data-by-Sally-Jenkinson" class="headerlink" title="An Introduction to Open Data, by Sally Jenkinson"></a>An Introduction to Open Data, by Sally Jenkinson</h3><p>Sally talked about how useful open data is and its applications. She went through some APIs and explained how the use of their data is very limited due to its Terms of Use, as opposed to other sets of data that are free to use.</p><p>A good example was MusicBrainz, that I’ve seen myself used by lots of hackers in the music hack events we use to attend.</p><h3 id="Freedom-Can-Be-Designed-by-Rejo-Zenger"><a href="#Freedom-Can-Be-Designed-by-Rejo-Zenger" class="headerlink" title="Freedom Can Be Designed, by Rejo Zenger"></a>Freedom Can Be Designed, by Rejo Zenger</h3><p>Rejo explained how large companies are getting more and more data from users and what we can do to limit it. He encouraged developers to ask for as few data as it’s needed in our websites and applications.</p><h3 id="Hands-On-Web-Audio-by-Soledad-Penad-233-s"><a href="#Hands-On-Web-Audio-by-Soledad-Penad-233-s" class="headerlink" title="Hands-On Web Audio, by Soledad Penad&#233;s"></a>Hands-On Web Audio, by Soledad Penad&#233;s</h3><p>Soledad explained how the Web Audio API works and combined it with WebGL to make some futuristic visualizations. She also used the microphone and mouse to interact with sound waves, which were displayed using WebGL. <a href="/assets/images/posts/fronteers-2015-soledad-penades.jpg"><img src="/assets/images/posts/fronteers-2015-soledad-penades.jpg" alt="Soledad Penadés presenting in Fronteers 2015"></a> <em>&uarr; Soledad Penadés talking about Audio API and WebGL</em></p><h3 id="But-What-About-Old-Browsers-Embracing-New-CSS-When-Your-Users-Are-Stuck-in-the-Past-by-Rachel-Andrew"><a href="#But-What-About-Old-Browsers-Embracing-New-CSS-When-Your-Users-Are-Stuck-in-the-Past-by-Rachel-Andrew" class="headerlink" title="But What About Old Browsers?!? Embracing New CSS When Your Users Are Stuck in the Past by Rachel Andrew"></a>But What About Old Browsers?!? Embracing New CSS When Your Users Are Stuck in the Past by Rachel Andrew</h3><p>Rachel went through the Flexbox and CSS Grid specifications and encouraged everyone to start using them, even in small components, as a way to increase awareness and make browser vendors continue implementing the specs. <a href="/assets/images/posts/fronteers-2015-rachel-andrew.jpg"><img src="/assets/images/posts/fronteers-2015-rachel-andrew.jpg" alt="Rachel Andrew presenting in Fronteers 2015"></a> <em>&uarr; Rachel Andrew going through some aspects of the CSS Flexbox and Grid specification</em></p><h3 id="The-Art-of-Debugging-by-Remy-Sharp"><a href="#The-Art-of-Debugging-by-Remy-Sharp" class="headerlink" title="The Art of Debugging by Remy Sharp"></a>The Art of Debugging by Remy Sharp</h3><p>This was a very practical talk, in which Remy explained he approached to debugging websites. Although this is something that we do ourselves everyday, it was good to see him using Chrome’s Developer Tools to find a memory leak, or use commands like <code>$</code>, <code>$_</code>, <code>$$</code> or <code>copy()</code> in the console as handy helpers.</p><p>He also showed network throttling and screen capture in the timeline. <a href="/assets/images/posts/fronteers-2015-remy-sharp.jpg"><img src="/assets/images/posts/fronteers-2015-remy-sharp.jpg" alt="Remy Sharp presenting in Fronteers 2015"></a> <em>&uarr; Remy Sharp explaining how he approaches debugging. Good overview of several developer tools and widely unknown features of Chrome’s developer tools</em></p><p><em>Update 2015-10-15: Remy has published <a href="https://remysharp.com/2015/10/14/the-art-of-debugging" target="_blank" rel="external">an accompanying article for this talk</a>.</em></p><h3 id="Of-Gaps-Fillers-and-Empty-Spaces-by-Christian-Heilmann"><a href="#Of-Gaps-Fillers-and-Empty-Spaces-by-Christian-Heilmann" class="headerlink" title="Of Gaps, Fillers and Empty Spaces by Christian Heilmann"></a>Of Gaps, Fillers and Empty Spaces by Christian Heilmann</h3><p>Christian reminded us how fortunate we were to be able to attend these conferences, and encouraged developers to embrace progressive enhancement, starting from the basis, and helping other developers who wanted to start in web development world. <a href="/assets/images/posts/fronteers-2015-christian-heilmann.jpg"><img src="/assets/images/posts/fronteers-2015-christian-heilmann.jpg" alt="Christian Heilmann presenting in Fronteers 2015"></a> <em>&uarr; Christian Heilmann during his presentation in Fronteers</em></p>]]></content>
    
    <summary type="html">
    
      Fronteers 2015 - Some notes about the conference in Amsterdam.
    
    </summary>
    
    
      <category term="conference" scheme="https://jmperezperez.com/tags/conference/"/>
    
  </entry>
  
  <entry>
    <title>SSL all the things</title>
    <link href="https://jmperezperez.com/github-pages-ssl-custom-domain/"/>
    <id>https://jmperezperez.com/github-pages-ssl-custom-domain/</id>
    <published>2015-10-09T07:35:00.000Z</published>
    <updated>2016-11-21T08:16:50.000Z</updated>
    
    <content type="html"><![CDATA[<p><em>… or why I have migrated my site to SSL</em>. I have been willing to use HTTPS on my site for some time, especially to be able to play with some new technologies like Service Workers. And, if GitHub implements it, <a href="https://en.wikipedia.org/wiki/HTTP/2#Encryption" target="_blank" rel="external">HTTP/2</a>.</p><p>I’m using GitHub Pages with a custom domain to power this blog and the pages for my GitHub projects. While GitHub Pages can be served using HTTPS, if you define a custom domain you need to manage this.</p><a id="more"></a><h2 id="How-to-set-up"><a href="#How-to-set-up" class="headerlink" title="How to set up"></a>How to set up</h2><p>A simple search got me to <a href="https://sheharyar.me/blog/free-ssl-for-github-pages-with-custom-domains/" target="_blank" rel="external">Set Up SSL on Github Pages With Custom Domains for Free</a>, where it’s explained how to use Cloudfare to add SSL to your domain. The steps are quite clear and I got it set up in a few minutes. And after some hours has propagated the server name configuration.</p><p>After making the change I went through some additional steps:</p><ul><li>Add a canonical link in your pages that points to the HTTPS URL.</li><li>Add a basic protocol check to redirect to the secure version of the page if accessed using HTTP.</li><li>Change the address for the site in the Google Analytics profile.</li><li>Create a new profile on Google Webmaster Tools for the HTTPS version. I thought it would be possible to replace the address or add a new site to a certain profile, but it’s not.</li></ul><h2 id="Why-switching-to-SSL"><a href="#Why-switching-to-SSL" class="headerlink" title="Why switching to SSL"></a>Why switching to SSL</h2><p>You might wonder why this site, a static blog that doesn’t deal with user’s private information, needs SSL. I consider HTTPS to be a sign of a good network citizen. In addition, some of my projects use 3rd party APIs like Spotify’s Web API, and the token retrieval and storage will be even more secure with HTTPS. And as I said, this will allow me to do some hacking with new browser APIs.</p><p><strong>Update December 4th, 2015</strong>: CloudFlare has just enabled HTTP/2 for the sites using their SSL, which means that if your browser supports it, you should be getting this page using HTTP/2.</p><h2 id="Performance-implications"><a href="#Performance-implications" class="headerlink" title="Performance implications"></a>Performance implications</h2><p>Migrating to HTTPS has a small effect in terms of performance. The requests will take longer to be fulfilled due to the negotiation phase of the protocol, and the decryption.</p><p>Fortunately, I try to keep the amount of requests to a minimum, and it payed off when applying SSL. If you are curious, I have prepared a <a href="http://www.webpagetest.org/video/compare.php?tests=151009_JQ_F73,151009_JT_F76" target="_blank" rel="external">WebPageTest comparison between this site served on HTTP and HTTPS</a>.</p><p>There are some initiatives to make it easier to web owners to integrate SSL. <a href="https://letsencrypt.org/" target="_blank" rel="external">Let’s Encrypt</a> is one of them, and it seems they will offer free certificates quite soon.</p>]]></content>
    
    <summary type="html">
    
      Adding SSL to your site can be super easy. If you are using GitHub Pages with a custom domain, read this.
    
    </summary>
    
    
      <category term="ssl" scheme="https://jmperezperez.com/tags/ssl/"/>
    
  </entry>
  
  <entry>
    <title>iOS 9 and content blockers</title>
    <link href="https://jmperezperez.com/ios-ads-blockers/"/>
    <id>https://jmperezperez.com/ios-ads-blockers/</id>
    <published>2015-09-21T15:33:00.000Z</published>
    <updated>2016-11-21T08:17:06.000Z</updated>
    
    <content type="html"><![CDATA[<p>Everyone is talking about ad-blockers these days after the release of iOS 9. But we should talk more about the “content blockers” feature in general, which can, by default, block scripts, fonts or images. What you can do as a web developer is what you should have been doing until now: don’t take anything for granted and follow a progressive enhancement approach.</p><a id="more"></a><p>I have read lots of articles about why it is a good or bad idea to use these blockers, and I can understand both sides of the discussion. I get that it can make things difficult for businesses that rely on advertising and tracking scripts to finance themselves, and I also understand that as a user I want to see web content quickly. If that comes with savings in bandwidth, double win.</p><p>If I were to choose a post with which I agree, I would pick <a href="http://meyerweb.com/eric/thoughts/2015/09/19/content-blocking-primer/" target="_blank" rel="external">Content Blocking Primer</a>. It doesn’t say that this is the end of the world, and encourages web developers to do what they should have been doing all this time.</p><p>There have been browser extensions to block certain content for a long time. But it’s now when it gets built-in and easily accessible for everyone, not necessarily tech-savvy ones.</p><h2 id="No-scripts"><a href="#No-scripts" class="headerlink" title="No scripts"></a>No scripts</h2><p>Our content (at least the most important bit) should ideally be rendered server side. This improves load time and makes all bots index our content.</p><blockquote><p>“But Google Bot is able to run Javascript”, you say.</p></blockquote><p>Truth is that there are other bots out there that might not be that smart. Say someone shares a link to your site on Twitter. A Twitter bot goes and makes a request to that page and tries to use its metadata to show a nice Twitter Card. Facebook? Same story.</p><p>Relying on Javascript for our main content makes us also vulnerable to SPOF issues. Say the JS file has a typo, or maybe the CDN that contains a JS file you need is not accessible in that moment. If your content can be rendered server-side, the user will still be able to see it.</p><blockquote><p>“But I need Javascript for my site to work!” you claim.</p></blockquote><p>You are probably right for this one, but more often than not you depend on Javascript because you didn’t think of a scenario in which Javascript wasn’t available. After all, who disables Javascript these days! <em>Note: I’ve done this and I continue doing it, so you can blame me too.</em></p><p>Say you use Javascript for a fancy lazy-loading component that makes your site faster by requesting images only when they are within the viewport. You don’t want the browser to start making the requests as soon as it gets the markup, so you do something like:</p><figure class="highlight html"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"image"</span> <span class="attr">data-img</span>=<span class="string">"http://example.com/image.jpg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure><p>and use Javascriot to either replace the <code>&lt;div/&gt;</code> with an <code>&lt;img/&gt;</code> or set its <code>background</code> using CSS. Now imagine the browser is not running Javascript, in which case the image won’t be shown.</p><p>Now have a look at this snippet:</p><figure class="highlight html"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"image"</span> <span class="attr">data-img</span>=<span class="string">"http://example.com/image.jpg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">noscript</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"http://example.com/image.jpg"</span>&gt;</span><span class="tag">&lt;/<span class="name">noscript</span>&gt;</span></div></pre></td></tr></table></figure><p>It adds a <code>&lt;noscript&gt;</code> tag that will make the browser render the content when it doesn’t have Javascript.</p><blockquote><p>“But then you are downloading all the images” you say.</p></blockquote><p>And you are right, but maybe that is better than not loading any image at all.</p><p>Tracking is something to think of too. A script like Google Analytics’ wouldn’t run, and the visit wouldn’t be reported. This is a problem if you rely on these data, in which case you will need to make the request server-side using something like <a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/devguide" target="_blank" rel="external">Analytics Measurement Protocol</a>.</p><h2 id="Custom-fonts"><a href="#Custom-fonts" class="headerlink" title="Custom fonts"></a>Custom fonts</h2><p>Are you really worried about custom fonts? You should already be providing a font stack with default system fonts that are used when the custom one fails to load (or after a certain timeout). In addition, you should be thinking of avoiding the “FOIT” (Flash of Invisible Text) if you want the user to be able to see the text quicker. I highly recommend you check <a href="https://www.filamentgroup.com/lab/font-events.html" target="_blank" rel="external">Font Loading Revisited with Font Events</a>, and make a couple of tests using <a href="http://webpagetest.org" target="_blank" rel="external">WebPageTest</a> to see the impact of custom fonts in your site.</p><blockquote><p>“But I use custom fonts to show icons!” you shout.</p></blockquote><p><a href="https://css-tricks.com/icon-fonts-vs-svg/" target="_blank" rel="external">Inline SVG vs Icon Fonts</a> is a great post that compares SVG with icon fonts. tl;dr? you can use SVGs instead of Web Fonts.</p><h1 id="Is-this-whole-blocking-thing-bad-for-the-web"><a href="#Is-this-whole-blocking-thing-bad-for-the-web" class="headerlink" title="Is this whole blocking thing bad for the web?"></a>Is this whole blocking thing bad for the web?</h1><p>Sometimes I believe we, as web developers, should do more in order to avoid third-party scripts from landing on the sites we build. The web has become a container where it is far too easy to drop things to, and it looks like one more script doesn’t damage that much.</p><p>At the same time I wonder what the situation is in the native apps world. Everything seems so fast when you install an app. Make a quick test accessing your favourite newspaper from your phone, both on the web and through their app. If it’s not <a href="http://www.theguardian.com/" target="_blank" rel="external">The Guardian</a>, which have done a great job with their website, chances are that the web is much slower than their app. And then everyone nods when the read about <a href="https://instantarticles.fb.com/" target="_blank" rel="external">Facebook’s Instant Articles</a> and blames the web for its slowness.</p><p>The web is deliberately slower not because the technology behind it, but because of the bloated set of non-sense third-party stuff we have been putting into.</p><p>I am really looking forward to seeing where this takes us.</p>]]></content>
    
    <summary type="html">
    
      Some opinions on ads and content blockers and how they affect web development.
    
    </summary>
    
    
      <category term="progressive" scheme="https://jmperezperez.com/tags/progressive/"/>
    
  </entry>
  
  <entry>
    <title>Using ES6 today</title>
    <link href="https://jmperezperez.com/use-es6-today/"/>
    <id>https://jmperezperez.com/use-es6-today/</id>
    <published>2015-07-20T06:20:00.000Z</published>
    <updated>2016-11-21T08:17:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>Yesterday I was reading <a href="https://medium.com/javascript-scene/how-to-use-es6-for-isomorphic-javascript-apps-2a9c3abe5ea2" target="_blank" rel="external">How to Use ES6 for Universal JavaScript Apps</a> and decided to create <a href="https://github.com/JMPerez/es6-template" target="_blank" rel="external">a small template</a> from which I can start a project using ES6 both client and server-side. <em>Note: You can replace the term “ES6” with ES2015, ES.next or whatever it’s called today, you get the idea.</em></p><a id="more"></a><p>Although everyone is promoting ES6 nowadays, the truth is that using it in a real project is not that straightforward. I spent some time with <a href="https://github.com/JMPerez/linkedin-to-json-resume" target="_blank" rel="external">LinkedIn to JSON Résumé</a> trying to figure out how to easily compile to ES5 and how to import modules as defined in ES6 instead of NodeJS’s <code>require</code>.</p><p>Generally speaking I haven’t been a big fan of CoffeeScript. Nor LESS nor SASS. I could use them in a small project to understand their reason to be, but I haven’t enough reasons to sell it to my colleagues when building or rewriting a real project.</p><p>It’s not that it doesn’t have its advantages, it’s that today the hot thing is X and tomorrow is Y. I’m even using <code>Makefile</code> in some projects just to not have to decide between <code>grunt</code> and <code>gulp</code>.</p><p>Sticking to the standard does make sense. And using tools to polyfill it until it becomes a reality in all modern browsers.</p><p>So I can’t but recommend you start to get familiar with ES6 and try to apply it in small projects first, to get used to it and be better prepared for the coming ES7.</p>]]></content>
    
    <summary type="html">
    
      Setting up ES6 in your next web project isn&#39;t that difficult... if you know how.
    
    </summary>
    
    
      <category term="es6" scheme="https://jmperezperez.com/tags/es6/"/>
    
  </entry>
  
  <entry>
    <title>What I&#39;ve been up to recently</title>
    <link href="https://jmperezperez.com/what-i-have-been-up-to/"/>
    <id>https://jmperezperez.com/what-i-have-been-up-to/</id>
    <published>2015-06-27T09:55:00.000Z</published>
    <updated>2016-11-21T08:17:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>Yes! It’s been a while since I last posted on this blog. I haven’t come up with new ideas for some time, but I do have been working on some projects I had on GitHub and needed a revisit.</p><a id="more"></a><h2 id="Calculating-tempo-of-a-song-using-Javascript"><a href="#Calculating-tempo-of-a-song-using-Javascript" class="headerlink" title="Calculating tempo of a song using Javascript"></a>Calculating tempo of a song using Javascript</h2><p>I recently realised the <a href="https://github.com/JMPerez/beats-audio-api" target="_blank" rel="external">site for calculating the BPM for a song</a> didn’t work on iPhone. After some research it turned out that the audio <code>OfflineContext</code> behaviour is different on iOS mobile than in the rest of platforms. Also, I was composing a dynamic SVG that result in the browser rendering an empty SVG, ignoring its contents. Hopefully that’s fixed now too.</p><h2 id="LinkedIn-to-JSON-Resume"><a href="#LinkedIn-to-JSON-Resume" class="headerlink" title="LinkedIn to JSON Resume"></a>LinkedIn to JSON Resume</h2><p>I am a big fan of APIs. Ever since I started using them for my end career project at University, I have worked both on implementing and consuming them.</p><p>Companies exposing their data through public APIs benefit from interesting integrations, expanding the platforms and use cases they have presence. But they are also afraid of giving out business core data for free.</p><p><a href="http://thatmikeflynn.com/2012/08/17/oh-twitter/" target="_blank" rel="external">Twitter</a>, <a href="http://techcrunch.com/2014/06/13/netflix-api-shutdown/" target="_blank" rel="external">Netflix</a> or <a href="http://thenextweb.com/dd/2015/02/12/linkedin-takes-aim-developers-plans-lock-apis/" target="_blank" rel="external">LinkedIn</a> are some well known cases of APIs that have introduced changes to become more restrictive. These changes are never welcome by developers, but nevertheless applications relying on any 3rd party API will always be prone to break.</p><p>So yes, the <a href="https://github.com/JMPerez/linkedin-to-json-resume" target="_blank" rel="external">the LinkedIn to JSON Resume exporter</a> broke because LinkedIn only allows apps access to a user’s full profile if those apps are used as part of a “apply for this position” section of a company’s site. That’s even though the user is always in control of what data an application can access, using a permission dialog (OAuth scopes).</p><p>Luckily there is a way for users to export their LinkedIn data, and that’s what the exporter tool is using. It was also my first project written using ES6 / ES.netxt / ES2015, which uses browserify + babelify to run the code on a browser.</p><p>The code is similar to <em>regular</em> Javascript, with some syntactic sugar, but I think it was a good opportunity to get used to the new syntax and get on board with the latest additions to the language.</p><h2 id="RAML-to-Swagger"><a href="#RAML-to-Swagger" class="headerlink" title="RAML to Swagger"></a>RAML to Swagger</h2><p>I have been exploring API specification languages for the creation of wrappers and documentation. <a href="http://www.michaelthelin.se/?p=861" target="_blank" rel="external">Michael Thelin</a> writes about how we are using RAML in Spotify for building the <a href="https://developer.spotify.com/web-api/console/" target="_blank" rel="external">Spotify Web API Console</a>, which has results in open-sourcing <a href="https://github.com/spotify/ramlfications" target="_blank" rel="external">the RAML python parser</a> that <a href="https://github.com/econchick" target="_blank" rel="external">Lynn Root</a> developed as part of the console.</p><p>There are lots of tools built around RAML and Swagger for creating documentation, libraries, visualisations or even mock servers.</p><p>I didn’t like the very few converters from RAML to Swagger, so I decided to start mine. Even though they are not fully equivalent, the <a href="https://github.com/JMPerez/raml2swagger" target="_blank" rel="external">raml2swagger</a> script does a decent job, and will allow us (and hopefully whoever needs it) explore the whole myriad of tools for API specifications, starting from a RAML spec.</p><hr><p>That’s all for now!</p>]]></content>
    
    <summary type="html">
    
      Some open-source projects I have been working on recently. Rest APIs, ES6 and Audio API.
    
    </summary>
    
    
      <category term="es6" scheme="https://jmperezperez.com/tags/es6/"/>
    
  </entry>
  
  <entry>
    <title>On widgets, popups and communication between them</title>
    <link href="https://jmperezperez.com/communicating-widgets-with-popups/"/>
    <id>https://jmperezperez.com/communicating-widgets-with-popups/</id>
    <published>2014-12-13T09:45:00.000Z</published>
    <updated>2016-11-21T08:17:26.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>tl;dr</strong>: Communication between an iframe and a popup is not straightforward. If you are implementing a widget-ish element that needs to communicate with other page, Have a read at this (and test your solution on multiple platforms).</p><a id="more"></a><h3 id="An-overview"><a href="#An-overview" class="headerlink" title="An overview"></a>An overview</h3><p>Imagine you want to develop a widget that can be embedded as an iframe in any website. The widget consists mainly on a button that will perform an action. You have seen this before: <em>Like</em> for Facebook, <em>Follow</em> for Twitter, <em>Follow</em> or <em>Share</em> for LinkedIn.</p><p>When you click the button you will be prompted with a login form (if not logged in on the service) and after a successful login you will be liking/following/sharing what you wanted.</p><h3 id="On-popups-and-redirections"><a href="#On-popups-and-redirections" class="headerlink" title="On popups and redirections"></a>On popups and redirections</h3><p>You probably want the login form to be displayed in a not too intrusive way. You might want to embed it in an iframe, but this shouldn’t be allowed by the service. An iframe would hide the URL of the login page, and URLs are a guarantee for the user that the form belongs to the site it is supposed to belong. Otherwise it would be hard to distinguish whether the login form comes from the real site or it is a phishing attempt.</p><p>The alternatives are opening a popup or redirecting the user to the login form. I personally like the popup solution. It doesn’t cover the whole page, keeps the context of the widget at sight, and also keeps the state of the page.</p><p>Working with popups means that you need to think carefully what is going to happen from the moment the user clicks the button until you want to open the popup. As soon as a function execution is not a direct result of an action initiated by the user. This makes totally sense, since we don’t want to see unsolicited popups opening while we see a page. As you see, we have again the browser preventing malicious behaviours, but making it difficult for developers that just want to use features for the good.</p><p>Opening a popup seems a plausible solution. The login form will return some type of identifier / access token to the iframe when the user logs in. It seems easy but…</p><h3 id="Defining-the-scenario"><a href="#Defining-the-scenario" class="headerlink" title="Defining the scenario"></a>Defining the scenario</h3><p>Let’s suppose that the site <code>www.example.com</code> embeds an iframe (from now on, <strong>the iframe</strong>) served from <code>www.widget.com</code>. The iframe will try to open a popup (from now on, <strong>the popup</strong>) served from the same domain as the widget. That popup will show a login form and will try to communicate back to the iframe when the user logs in. <img src="/assets/images/posts/widget-popup-different-domain.png" alt="A widget and a popup served from a different domain."></p><h3 id="I-didn’t-tell-you-about-mobile"><a href="#I-didn’t-tell-you-about-mobile" class="headerlink" title="I didn’t tell you about mobile"></a>I didn’t tell you about mobile</h3><p>On a mobile browser, a popup opens a new tab, which is more suitable for their screen sizes. Apart from that, the OS can perform some optimizations to save memory and CPU due to foregrounded browser tabs.</p><p>Note: I haven’t performed a deep research to see what combinations of operating system and browser exhibit each of these issues. But it’s enough with one of them failing to try to implement a workaround.</p><h4 id="window-opener-is-undefined"><a href="#window-opener-is-undefined" class="headerlink" title="window.opener is undefined"></a><code>window.opener</code> is undefined</h4><p>So you try this:</p><pre><code>var w = window.open(&lt;login_url&gt;,...)
</code></pre><p>then you would expect <code>&lt;login_url&gt;</code> to have access to <code>window.opener</code>. However, iOS won’t keep a reference to the opener. This prevents us from exposing a function in the iframe that we can access from the popup.</p><p>Try it on <a href="http://jsfiddle.net/JMPerez/hgvsejvb/show/" target="_blank" rel="external">JSFiddle</a>.</p><h4 id="storage-is-not-triggered-when-writing-in-localStorage"><a href="#storage-is-not-triggered-when-writing-in-localStorage" class="headerlink" title="storage is not triggered when writing in localStorage"></a><code>storage</code> is not triggered when writing in <code>localStorage</code></h4><p>On iOS, don’t expect a <code>storage</code> event to be triggered from the popup and capture it from the iframe. It won’t.</p><h4 id="window-open-doesn’t-keep-a-reference-to-the-popup"><a href="#window-open-doesn’t-keep-a-reference-to-the-popup" class="headerlink" title="window.open doesn’t keep a reference to the popup"></a>window.open doesn’t keep a reference to the popup</h4><p>On Chrome for iOS, you would do:</p><pre><code>var w = window.open(&lt;login_url&gt;,...);
console.log(w);   // prints undefined
</code></pre><p><code>w</code> should have a reference to the opened popup, which we could use, for instance, to poll its <code>w.closed</code> attribute to see if the user has closed it. This would be useful to detect that the user ignored the login form. However, <code>w</code> won’t store a reference to the popup on Chrome for iOS.</p><p>Try it on <a href="http://jsfiddle.net/JMPerez/4d0g5csa/show" target="_blank" rel="external">JSFiddle</a>.</p><h4 id="window-close-doesn’t-work-in-the-popup"><a href="#window-close-doesn’t-work-in-the-popup" class="headerlink" title="window.close doesn’t work in the popup"></a>window.close doesn’t work in the popup</h4><p>On Safari for iOS you can’t close yourself. This means that if you were thinking of passing the information to the iframe and then close yourself, you won’t be able to do that.</p><p>Try it on <a href="http://jsfiddle.net/JMPerez/18yzm54k/show" target="_blank" rel="external">JSFiddle</a>.</p><h3 id="More-limitations"><a href="#More-limitations" class="headerlink" title="More limitations"></a>More limitations</h3><p>If you have read so far you will wonder whether there are still more issues. And yes, there are. One could assume that mobile browsers limit our functionality for saving resources, but now we have also the browsers using quite restrictive privacy preferences.</p><p>Welcome Safari 8 and IE 11.</p><h4 id="Reading-localStorage-from-a-host-different-than-the-page’s-host-will-fail"><a href="#Reading-localStorage-from-a-host-different-than-the-page’s-host-will-fail" class="headerlink" title="Reading localStorage from a host different than the page’s host will fail"></a>Reading localStorage from a host different than the page’s host will fail</h4><p>Some browsers come with default privacy preferences that will prevent you from carrying out certain operations. <a href="/assets/images/posts/safari-8-privacy-settings.png"><img src="/assets/images/posts/safari-8-privacy-settings.png" alt="Privacy settings in Safari 8"></a></p><p>In the image above you can see Safari 8’s default privacy settings, with “Allow from websites I visit” checked.</p><p>You have learnt that passing messages from the popup to the parent is tricky. You then try to use <code>localStorage</code>. Then you realise browsers are blocking these read operations. Note that the iframe is served from a different host. The popup could write to localStorage, but the iframe served from the same host won’t be able to read its value.</p><p>However, a <code>storage</code> event will be triggered when writing in localStorage containing the new stored value. You can read the new value when capturing the event, but not if you try to access localStorage afterwards. Weird, but this is how it works.</p><p>And even weirder is that even though localStorage is being blocked, from the iframe you are able to read cookies written from the popup. One would assume that the same limitations should apply to cookies, but that’s not the case.</p><h3 id="What-to-do"><a href="#What-to-do" class="headerlink" title="What to do"></a>What to do</h3><p>So far, the best way I have found is:</p><ul><li>The popup will show a message like “If I don’t close myself, close me”.</li><li>The popup will write cookies and will write to localStorage</li><li>The iframe will listen to the <code>storage</code> event and will poll the cookies.</li></ul><p>It’s far from ideal but kind of works.</p>]]></content>
    
    <summary type="html">
    
      How to communicate from an iframe to a popup served from the same domain i.e. when using login forms in popups.
    
    </summary>
    
    
      <category term="popup" scheme="https://jmperezperez.com/tags/popup/"/>
    
      <category term="iframe" scheme="https://jmperezperez.com/tags/iframe/"/>
    
  </entry>
  
  <entry>
    <title>Detecting tempo of a song using browser&#39;s Audio API</title>
    <link href="https://jmperezperez.com/bpm-detection-javascript/"/>
    <id>https://jmperezperez.com/bpm-detection-javascript/</id>
    <published>2014-08-09T04:40:00.000Z</published>
    <updated>2016-11-21T08:17:31.000Z</updated>
    
    <content type="html"><![CDATA[<p>This article explains some ideas behind a small project to detect the tempo of a song using the Audio API. I recommend you to have a look at these links before reading the rest of the article: <a href="http://jmperezperez.com/beats-audio-api/">Demo</a> and <a href="https://github.com/JMPerez/beats-audio-api" target="_blank" rel="external">Code on GitHub</a>. <img src="/assets/images/posts/bpm-detection-example.png" alt="Beat Detection Algorithm Example"></p><a id="more"></a><h2 id="Beat-detection-using-Audio-API"><a href="#Beat-detection-using-Audio-API" class="headerlink" title="Beat detection using Audio API"></a>Beat detection using Audio API</h2><p>A couple of days ago I came across <a href="http://joesul.li/van/beat-detection-using-web-audio/" target="_blank" rel="external">Beat Detection Using Web Audio</a>, a blog post by <strong>Joe Sullivan</strong> where he explained a simple algorithm to calculate the tempo of a song using the Audio API. After reading it, I was curious about how well the algorithm would work for other tracks.</p><p>So I sat down and coded a small project using his algorithms and adding a search box to search for songs, and display the result for them.</p><p>The algorithm is supposed to work better with the central fragment of a song. This avoids the parts with lower volume and fewer signals we can take to detect the beats.</p><h2 id="Searching-songs-and-obtaining-a-preview-MP3"><a href="#Searching-songs-and-obtaining-a-preview-MP3" class="headerlink" title="Searching songs and obtaining a preview MP3"></a>Searching songs and obtaining a preview MP3</h2><p>The APIs of some music streaming services provide a sample of 30 seconds of every song in their catalog. We can’t choose what 30 seconds of a track we want (i.e. what the starting point of the chunk is), but they will usually be a fragment of the most representative part of the song, and this is a good candidate for the algorithm.</p><p>The bitrate of the samples is rather low, around 96 kb/s according to my tests. I have tried to use them previously for my <a href="http://jmperezperez.com/karaoke/">karaoke project</a>, but the result was very noisy.</p><p>Since I’m more than familiar with the <a href="https://developer.spotify.com/web-api/" target="_blank" rel="external">Spotify Web API</a>, I have chosen it for <a href="https://developer.spotify.com/web-api/search-item/" target="_blank" rel="external">searching tracks</a>. The search is also quite flexible and normally is enough with the track name (without artist name) to find the song we want.</p><p>The Search endpoint returns a list of tracks, and their <code>preview_url</code> property points to an MP3 file that we can plug in straight to an <code>AudioContext</code> to process it.</p><h2 id="Calculating-the-tempo"><a href="#Calculating-the-tempo" class="headerlink" title="Calculating the tempo"></a>Calculating the tempo</h2><p>I am following the algorithm described (in great detail) by Joe Sullivan. I have tweaked it a bit to:</p><ol><li><p><strong>Dynamically adjust the threshold to identify peaks</strong>: In some cases a threshold of 0.8 was simply too much and the amount of representative peaks returned too low for doing a proper guess. Thus, I lower the threshold until I have a few more peaks for the given sample.</p></li><li><p><strong>Round the theoretical tempo to the closest integer</strong>. Otherwise it is rather impossible to get multiple intervals with the same value. At first sight we lose precision, but tempos are usually integers anyway.</p></li></ol><p>To check how well the algorithm works I wanted to know the BPM of the song, calculated by some trustable source. Luckily enough, the same Spotify API provides an endpoint to <a href="https://developer.spotify.com/web-api/get-audio-features/" target="_blank" rel="external">get Audio Features for a Track</a>. The first version of this project used The Echo Nest API to obtain the tempo of a song. Some time ago this API was discontinued, and this and other endpoints were merged into Spotify’s Web API. That means we don’t need to match track identifiers from different music services, making everything easier.</p><p>The endpoint returns a JSON object with several features of the track, including its <code>tempo</code>.</p><h2 id="Rendering-the-peaks-and-playing-the-track"><a href="#Rendering-the-peaks-and-playing-the-track" class="headerlink" title="Rendering the peaks and playing the track"></a>Rendering the peaks and playing the track</h2><p>From Joe’s post, I really liked the simple graphs showing the peaks of a song as a way of representing what the algorithm was doing. I decided to do the same, and also add a button to play the track along with an indicator that goes through the graph and helps us see what peaks were detected by the algorithm.</p><h2 id="Enhancements"><a href="#Enhancements" class="headerlink" title="Enhancements?"></a>Enhancements?</h2><p>I’m sure there must be better algorithms to find out the tempo of a song, but this one has proven to be very simple and effective for most of the “danceable” tracks, between 90 and 180 BPM. And I think it’s a fun way to use the modern browser’s recent APIs.</p>]]></content>
    
    <summary type="html">
    
      Article about project for detecting BPM of a track using the Audio API, in combination with the Spotify Web API.
    
    </summary>
    
    
      <category term="spotify" scheme="https://jmperezperez.com/tags/spotify/"/>
    
      <category term="bpm" scheme="https://jmperezperez.com/tags/bpm/"/>
    
  </entry>
  
</feed>
