<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Tutorial: Implementing Facebook's BigPipe Using ASP.Net MVC - Part 3 - JMPerez Blog</title><meta name=description content="Last part of my tutorial on Implementing BigPipe, focused on browser side, loading CSS and JS resources efficiently using a small script."><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=author href="https://plus.google.com/107456024651797783420"><link rel=alternate type=application/rss+xml title="Jose M. Perez" href=https://jmperezperez.com/feed.xml><meta name=twitter:card content=summary><meta name=twitter:url content="https://jmperezperez.com/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-3/" property=og:url><meta name=twitter:title content="Tutorial: Implementing Facebook's BigPipe Using ASP.Net MVC - Part 3" property=og:title><meta name=twitter:description content="Last part of my tutorial on Implementing BigPipe, focused on browser side, loading CSS and JS resources efficiently using a small script." property=og:description><meta name=twitter:site content=@jmperezperez><meta property=fb:app_id content=1702266270006013><meta property=fb:pages content="1639848659664211"><link rel=canonical href="https://jmperezperez.com/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-3/"><style>a,a:hover{color:#2a7cb2}.post::after,hr{display:block;clear:both}#page,body>header{position:relative}.pagination,.pagination a,body>header,footer{text-align:center}.code,code,pre{letter-spacing:0}*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin:0;padding:0;border:none;vertical-align:baseline;font:inherit}button,input{background:0 0;-webkit-appearance:none;-moz-appearance:none;appearance:none}body{background:#fff;color:#555;font-family:Georgia,Times;font-weight:300;font-style:normal;font-size:19px;line-height:1.725;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}blockquote,em{font-style:italic}@media(max-width:800px){body{font-size:17px}}@media(max-width:600px){body{font-size:15px}}h1,h2,h3,h4,h5{color:#212121;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;font-weight:600;font-size:1em;line-height:1.3;margin-bottom:1em}#menu a,h3{color:#666}#menu a,.button{font-weight:400}.post ol,.post ul,amp-video,iframe,p,video{margin:0 0 1em}.quote,blockquote,ol,ul{margin:0 0 15px}a{text-decoration:none;font-weight:inherit;-webkit-transition:color .15s ease-out,border-bottom-color .15s ease-out;-moz-transition:color .15s ease-out,border-bottom-color .15s ease-out;-o-transition:color .15s ease-out,border-bottom-color .15s ease-out;transition:color .15s ease-out,border-bottom-color .15s ease-out}h2,h3,strong{font-weight:400}p a{border-bottom:1px solid #eee}p a:hover{border-bottom-color:#212121}h1{font-size:1.7em}h2{color:#444;font-size:1.6em}h3{font-size:1.4em}h4{font-size:1.18em}h5{font-size:1em}p+h2,p+h3,p+h4,p+h5{padding-top:1em}a h1,a h2,a h3,a h4,a h5{-webkit-transition:color .15s ease-out;-moz-transition:color .15s ease-out;-o-transition:color .15s ease-out;transition:color .15s ease-out}a:hover h1,a:hover h2,a:hover h3,a:hover h4,a:hover h5{color:#3498db}blockquote{padding-left:20px;border-left:2px solid #ccc}ol,ul{padding-left:25px}ul{list-style:square}ol{list-style:decimal}sup{vertical-align:super}sub{vertical-align:sub}hr{margin:30px auto;width:50%;height:2px;background:#eee;color:#eee}.post,.post .svg-container object{width:100%}code,pre{overflow-x:auto;color:#333;font-family:Courier,Menlo,Monaco;font-size:.8em}.author,.tags,body>header{font-family:"Helvetica Neue",Helvetica,Arial,sans-serif}pre{padding:.8em 1em}code{margin:0}.post::after{content:''}body>header{overflow:hidden;padding:1em;width:100%;border-bottom:2px solid #eee}#menu{display:inline-block;margin:1px 0}#menu a{margin-left:15px;text-transform:uppercase;font-size:14px;padding:20px 10px}#menu a.current,#menu a:hover{color:#212121}#page{margin:0 auto;padding:3em 2em;max-width:40em}.wrapper{padding:7.5% 0;border-top:2px solid #eee}.wrapper:first-child{padding-top:0;border-top:none}.post{display:block}.post div[itemprop=articleBody]>p:first-child{color:#333}.post li{margin-bottom:.5em}.post p img{display:block;margin:5% auto;max-width:100%;border:1px solid #eee}.button,.tag-list,.tag-list li{display:inline-block}.post .svg-container{text-align:center;margin-bottom:5%;max-width:100%}video{height:auto;max-width:100%}.tags{font-size:.9em}.tag-list{padding:0}.tag-list li:after{content:', '}.tag-list li:last-child:after{content:''}.pagination a{min-width:30px;max-height:30px}footer{padding:2em;background:rgba(0,0,0,.05)}.button{padding:10px 20px;border-radius:20px;border:1px solid #555;background-color:#fff;color:#555;font-size:13px;line-height:10px;-webkit-transition:background-color .15s ease-out;-moz-transition:background-color .15s ease-out;-o-transition:background-color .15s ease-out;transition:background-color .15s ease-out}.button:hover{background-color:#3498db;color:#fff;border-color:transparent}.button.inactive{background-color:#ccc;color:#fff}.search-goog input{padding:10px;border:2px solid #ddd}.search-goog input[type=submit]{background-color:#ddd;cursor:pointer}@media only screen and (max-width:768px){#page,.wrapper{margin:0;max-width:100%;width:100%;padding:1.5em}.wrapper{padding:10% 0}.wraper::after{display:block;clear:both;content:''}.post{margin:0 auto;max-width:640px}}.outscreen{position:absolute;left:-1000px;top:auto;width:1px;height:1px;overflow:hidden}.callout{font-size:90%;padding:20px;margin:20px 0;border:1px solid #eee;border-left-width:5px;border-left-color:#777;border-radius:3px}.author{font-size:.8em;margin-bottom:2em}.author .name{line-height:1.5;padding-top:.35em}.bd,.media{overflow:hidden;zoom:1}.media .img{float:left}.avatar-img{border-radius:100%;height:3.5em;width:3.5em;margin-right:.5em}.highlight{border:1px solid #eee;margin-bottom:1em;overflow-x:auto}.code{display:block;background:#fff;color:#333;overflow-x:auto}.code .comment,.code .meta{color:#969896}.code .emphasis,.code .quote,.code .string,.code .strong,.code .template-variable,.code .variable{color:#df5000}.code .keyword,.code .selector-tag,.code .type{color:#a71d5d}.code .attribute,.code .bullet,.code .literal,.code .symbol{color:#0086b3}.code .name,.code .section{color:#63a35c}.code .tag{color:#333}.code .attr,.code .selector-attr,.code .selector-class,.code .selector-id,.code .selector-pseudo,.code .title{color:#795da3}.code .addition{color:#55a532;background-color:#eaffea}.code .deletion{color:#bd2c00;background-color:#ffecec}.code .link{text-decoration:underline}</style><link rel=amphtml href="/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-3/amp/"></head><body><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-39254352-1","auto"),ga("send","pageview");</script><header><nav id=menu><a href="/">JMPerez Blog</a> <a href="/projects/">Projects</a> <a href="/about-me/">About</a></nav></header><div id=page><article class=wrapper><div class=post><header><script type=application/ld+json>{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "Tutorial: Implementing Facebook's BigPipe Using ASP.Net MVC - Part 3",
  
  "description": "Last part of my tutorial on Implementing BigPipe, focused on browser side, loading CSS and JS resources efficiently using a small script.",
  
  "mainEntityOfPage":{
      "@type":"WebPage",
      "@id":"https://jmperezperez.com/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-3/"
  },
  "datePublished": "2010-09-27T17:25:11.000Z",
  "dateModified": "2016-11-21T08:22:18.000Z",
  
  "author": {
      "@type": "Person",
      "name": "Jose M. Perez"
  },
  "publisher": {
      "@type": "Organization",
      "name": "JMPerez Blog"
      
      ,
      "logo": {
        "@type": "ImageObject",
        "url": "https://jmperezperez.com/assets/images/logo.png",
        "width": 600,
        "height": 60
      }
      
  }
}</script><div class="media author"><div class=img><a href="/about-me/"><img src=/assets/images/jmperez.jpg class=avatar-img alt="" height=53 width=53></a></div><div class=bd><address class=name itemprop=author itemscope itemtype=https://schema.org/Person><a href="/about-me/" itemprop=name>José M. Pérez</a></address><meta class=post-data itemprop=datePublished content=2010-09-27T17:25:11.000Z>September 27 2010</div></div><h1 itemprop=headline>Tutorial: Implementing Facebook's BigPipe Using ASP.Net MVC - Part 3</h1></header><p>Parts of the tutorial</p><ol><li><a href=/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-1>Introduction to BigPipe</a></li><li><a href=/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-2>How ASP.Net MVC fits in the model. Registering and generating pagelets</a></li><li>Browser implementation of BigPipe. Loading pagelets and their resources effectively</li><li><a href=https://github.com/JMPerez/BigPipe target=_blank rel=external>Check out the demo Visual Studio solution</a></li></ol><p>In this third part of the tutorial to carry out a technique similar to BigPipe I will cover the browser side. BigPipe is not only focused on server side, but it also sets how the different resources that our pagelets need have to be requested and loaded in the document.</p><a id=more></a><h2 id=Registering-a-pagelet-and-its-resources><a href=#Registering-a-pagelet-and-its-resources class=headerlink title="Registering a pagelet and its resources"></a>Registering a pagelet and its resources</h2><p>In the Pagelet class I will declare a constructor that accepts a list of CSS files and a list of JavaScript files needed by the pagelet:<figure class="highlight csharp"><table><tr><td class=code><pre><div class=line><span class=function><span class=keyword>public</span> <span class=title>Pagelet</span>(<span class=params><span class=keyword>string</span> container, Func&lt;<span class=keyword>string</span>&gt; action, IEnumerable&lt;<span class=keyword>string</span>&gt; css, IEnumerable&lt;<span class=keyword>string</span>&gt; js</span>)</span></div><div class=line>&#123;</div><div class=line>    <span class=keyword>this</span>.Container = container;</div><div class=line>    <span class=keyword>this</span>.Action = action;</div><div class=line>    <span class=keyword>this</span>.Data = <span class=keyword>new</span> Data()</div><div class=line>    &#123;</div><div class=line>        Id = container,</div><div class=line>        Css = css,</div><div class=line>        Js = js</div><div class=line>    &#125;;</div><div class=line>&#125;</div></pre></td></tr></table></figure></p><p>In my sample code I am registering two pagelets in the View:<figure class="highlight csharp"><table><tr><td class=code><pre><div class=line>&lt;%  HttpRequest req = HttpContext.Current.Request;</div><div class=line>    Html.RegisterPagelet(<span class=keyword>new</span> Pagelet(</div><div class=line>        <span class=string>"pagelet1-pagelet"</span>,</div><div class=line>        () =&gt; Html.RenderActionToString(req, <span class=string>"home"</span>, <span class=string>"pagelet1"</span>),</div><div class=line>        <span class=keyword>new</span> []&#123;<span class=string>"../../Content/Pagelet1.css"</span>&#125;,</div><div class=line>        <span class=keyword>new</span> []&#123;<span class=string>"http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"</span>,</div><div class=line>                <span class=string>"../../Scripts/Pagelet1.js"</span>&#125;</div><div class=line>    )); %&gt;</div><div class=line></div><div class=line>...</div><div class=line>&lt;% Html.RegisterPagelet(<span class=keyword>new</span> Pagelet(</div><div class=line>    <span class=string>"pagelet2-pagelet"</span>,</div><div class=line>    () =&gt; Html.RenderActionToString(req, <span class=string>"home"</span>, <span class=string>"pagelet2"</span>),</div><div class=line>    <span class=keyword>new</span>[] &#123; <span class=string>"../../Content/Pagelet2.css"</span> &#125;,</div><div class=line>    <span class=literal>null</span></div><div class=line>    )); %&gt;</div></pre></td></tr></table></figure></p><p>As I said before, <code>Html.Action()</code> method can be used to store the result of an action in a string. However, it may throw exception if you use multi-threading to execute the different pagelets since it doesn’t keep a reference to original request. In fact, we are storing the current request in the <code>req</code> variable to avoid this exception when using <code>Html.RenderActionToString</code>. If you’d rather use a single-threaded <code>for</code> to go through the pagelets in the <code>ExecutePagelets</code> method (i.e. if you see that parallel <code>for</code> implies too much overload), then go for the <code>Action</code> method.</p><h2 id=Facebook’s-approach><a href=#Facebook’s-approach class=headerlink title="Facebook’s approach"></a>Facebook’s approach</h2><p>In this tutorial I am implementing a simple solution covering BigPipe principles from server to browser. However, Facebook’s implementation is far more complex, taking into account resource dependencies and events. If we have a look at a sample call to their <code>onPageletArrive</code> Javascript function, we can see that they pass a JSON object similar to this one:<figure class=highlight><table><tr><td class=code><pre><div class=line>&#123;</div><div class=line>    "id": ",</div><div class=line>    "phase": 4,</div><div class=line>    "is_last": true,</div><div class=line>    "append": false,</div><div class=line>    "bootloadable": [</div><div class=line></div><div class=line>    ],</div><div class=line>    "css": [</div><div class=line>        "MPQqY",</div><div class=line>        "uwtW6",</div><div class=line>        "wWhUT"</div><div class=line>    ],</div><div class=line>    "js": [</div><div class=line>        "RpPeo",</div><div class=line>        "C9ueD",</div><div class=line>        "q+PxV",</div><div class=line>        "Ok1Y0",</div><div class=line>        "dOwRG"</div><div class=line>    ],</div><div class=line>    "resource_map": [</div><div class=line></div><div class=line>    ],</div><div class=line>    "requires": [</div><div class=line></div><div class=line>    ],</div><div class=line>    "provides": [</div><div class=line></div><div class=line>    ],</div><div class=line>    "onload": [</div><div class=line></div><div class=line>    ],</div><div class=line>    "onafterload": [</div><div class=line></div><div class=line>    ],</div><div class=line>    "onpagecache": [</div><div class=line></div><div class=line>    ],</div><div class=line>    "onafterpagecache": [</div><div class=line></div><div class=line>    ],</div><div class=line>    "refresh_pagelets": [</div><div class=line></div><div class=line>    ],</div><div class=line>    "invalidate_cache": [</div><div class=line></div><div class=line>    ],</div><div class=line>    "content": [</div><div class=line></div><div class=line>    ],</div><div class=line>    "page_cache": false</div><div class=line>&#125;</div></pre></td></tr></table></figure></p><p>From there, we will cover <code>id</code>, <code>css</code>, <code>js</code> and <code>content</code> fields. Most of the rest of fields are self-explainable, and they could be implemented easily on our basic BigPipe implementation.</p><h2 id=Javascript-detection><a href=#Javascript-detection class=headerlink title="Javascript detection"></a>Javascript detection</h2><p>We will detect Javascript using a cookie that will be written using Javascript. The first request to our page will not send that cookie, so we will serve a non-BigPipe version. I prefer this to making a redirection to the same page if Javascript is enabled.</p><p>In the Site.Master, just before ending body tag we can add the Javascript detection code:<figure class="highlight csharp"><table><tr><td class=code><pre><div class=line>&lt;% <span class=keyword>if</span> (Request.Cookies[<span class=string>"js"</span>] == <span class=literal>null</span>) &#123; %&gt;</div><div class=line>&lt;script&gt;</div><div class=line><span class=keyword>var</span> exdate=<span class=keyword>new</span> Date();</div><div class=line>exdate.setDate(exdate.getDate()+<span class=number>90</span>);</div><div class=line>document.cookie = <span class=string>"js=true;expires="</span> + exdate.toUTCString();</div><div class=line>&lt;/script&gt;</div><div class=line>&lt;% &#125; %&gt;</div></pre></td></tr></table></figure></p><h2 id=Loading-CSS-and-JS><a href=#Loading-CSS-and-JS class=headerlink title="Loading CSS and JS"></a>Loading CSS and JS</h2><p>We will need a basic Javascript script that allows us:</p><ul><li>Load in parallel the set of CSS resources needed by each pagelet</li><li>Append the HTML code of a pagelet inside its container</li><li>Request in parallel all the Javascript files needed by the set of pagelets, once they all have been appended to the document, and execute them</li></ul><p>Moreover, the size of the script has to be as small as possible, since it will be a blocking script.</p><figure class="highlight js"><table><tr><td class=code><pre><div class=line><span class=keyword>var</span> Loader = <span class=function><span class=keyword>function</span> (<span class=params></span>) </span>&#123;</div><div class=line>    <span class=keyword>var</span> d = <span class=built_in>document</span>,</div><div class=line>        head = d.getElementsByTagName(<span class=string>"head"</span>)[<span class=number>0</span>];</div><div class=line></div><div class=line>    <span class=keyword>var</span> loadJs = <span class=function><span class=keyword>function</span> (<span class=params>url, cb</span>) </span>&#123;</div><div class=line>        <span class=keyword>var</span> script = d.createElement(<span class=string>'script'</span>);</div><div class=line>        script.setAttribute(<span class=string>'src'</span>, url);</div><div class=line>        script.setAttribute(<span class=string>'type'</span>, <span class=string>'text/javascript'</span>);</div><div class=line></div><div class=line>        <span class=keyword>var</span> loaded = <span class=literal>false</span>;</div><div class=line>        <span class=keyword>var</span> loadFunction = <span class=function><span class=keyword>function</span> (<span class=params></span>) </span>&#123;</div><div class=line>            <span class=keyword>if</span> (loaded) <span class=keyword>return</span>;</div><div class=line>            loaded = <span class=literal>true</span>;</div><div class=line>            cb &amp;amp;&amp;amp; cb();</div><div class=line>        &#125;;</div><div class=line>        script.onload = loadFunction;</div><div class=line>        script.onreadystatechange = loadFunction;</div><div class=line>        head.appendChild(script);</div><div class=line>    &#125;;</div><div class=line></div><div class=line>    <span class=keyword>var</span> cachedBrowser;</div><div class=line></div><div class=line>    <span class=keyword>var</span> browser = <span class=function><span class=keyword>function</span> (<span class=params></span>) </span>&#123;</div><div class=line>        <span class=keyword>if</span> (!cachedBrowser) &#123;</div><div class=line>            <span class=keyword>var</span> ua = navigator.userAgent.toLowerCase();</div><div class=line>            <span class=keyword>var</span> match = <span class=regexp>/(webkit)[ \/]([\w.]+)/</span>.exec(ua) ||</div><div class=line>			<span class=regexp>/(opera)(?:.*version)?[ \/]([\w.]+)/</span>.exec(ua) ||</div><div class=line>			<span class=regexp>/(msie) ([\w.]+)/</span>.exec(ua) ||</div><div class=line>			!<span class=regexp>/compatible/</span>.test(ua) &amp;amp;&amp;amp; <span class=regexp>/(mozilla)(?:.*? rv:([\w.]+))?/</span>.exec(ua) ||</div><div class=line>			[];</div><div class=line>            cachedBrowser = match[<span class=number>1</span>];</div><div class=line>        &#125;</div><div class=line>        <span class=keyword>return</span> cachedBrowser;</div><div class=line>    &#125;;</div><div class=line></div><div class=line>    <span class=keyword>var</span> loadCss = <span class=function><span class=keyword>function</span> (<span class=params>url, cb</span>) </span>&#123;</div><div class=line>        <span class=keyword>var</span> link = d.createElement(<span class=string>"link"</span>);</div><div class=line>        link.type = <span class=string>"text/css"</span>;</div><div class=line>        link.rel = <span class=string>"stylesheet"</span>;</div><div class=line>        link.href = url;</div><div class=line></div><div class=line>        <span class=keyword>if</span> (browser() == <span class=string>"msie"</span>)</div><div class=line>            link.onreadystatechange = <span class=function><span class=keyword>function</span> (<span class=params></span>) </span>&#123;</div><div class=line>                /loaded|complete/.test(link.readyState) &amp;amp;&amp;amp; cb();</div><div class=line>            &#125;</div><div class=line>        <span class=keyword>else</span> <span class=keyword>if</span> (browser() == <span class=string>"opera"</span>)</div><div class=line>            link.onload = cb;</div><div class=line>        <span class=keyword>else</span></div><div class=line>        <span class=comment>//FF, Safari, Chrome</span></div><div class=line>            (<span class=function><span class=keyword>function</span> (<span class=params></span>) </span>&#123;</div><div class=line>                <span class=keyword>try</span> &#123;</div><div class=line>                    link.sheet.cssRule;</div><div class=line>                &#125; <span class=keyword>catch</span> (e) &#123;</div><div class=line>                    setTimeout(<span class=built_in>arguments</span>.callee, <span class=number>20</span>);</div><div class=line>                    <span class=keyword>return</span>;</div><div class=line>                &#125;;</div><div class=line>                cb();</div><div class=line>            &#125;)();</div><div class=line></div><div class=line>        head.appendChild(link);</div><div class=line>    &#125;;</div><div class=line></div><div class=line>    <span class=keyword>return</span> &#123; <span class=attr>loadCss</span>: loadCss, <span class=attr>loadJs</span>: loadJs &#125;;</div><div class=line></div><div class=line>&#125; ();</div><div class=line></div><div class=line><span class=function><span class=keyword>function</span> <span class=title>PageLet</span>(<span class=params>p, domInserted</span>) </span>&#123;</div><div class=line>    <span class=keyword>var</span> data = p,</div><div class=line>	remainingCss = <span class=number>0</span>;</div><div class=line></div><div class=line>    <span class=keyword>var</span> loadCss = <span class=function><span class=keyword>function</span> (<span class=params></span>) </span>&#123;</div><div class=line>        <span class=comment>//load css</span></div><div class=line>        <span class=keyword>if</span> (data.Css &amp;amp;&amp;amp; data.Css.length) &#123;</div><div class=line>            remainingCss = data.Css.length;</div><div class=line>            <span class=keyword>for</span> (<span class=keyword>var</span> i = remainingCss; i--; )</div><div class=line>                Loader.loadCss(data.Css[i], <span class=function><span class=keyword>function</span> (<span class=params></span>) </span>&#123;</div><div class=line>                    ! --remainingCss &amp;amp;&amp;amp; insertDom();</div><div class=line>                &#125;);</div><div class=line>        &#125;</div><div class=line>        <span class=keyword>else</span></div><div class=line>            insertDom();</div><div class=line>    &#125;</div><div class=line></div><div class=line>    <span class=keyword>var</span> insertDom = <span class=function><span class=keyword>function</span> (<span class=params></span>) </span>&#123;</div><div class=line>        <span class=built_in>document</span>.getElementById(p.Id).innerHTML = p.Content;</div><div class=line>        domInserted();</div><div class=line>    &#125;</div><div class=line></div><div class=line>    <span class=keyword>var</span> loadJs = <span class=function><span class=keyword>function</span> (<span class=params></span>) </span>&#123;</div><div class=line>        <span class=keyword>if</span> (!data.Js) <span class=keyword>return</span>;</div><div class=line>        <span class=comment>//load js</span></div><div class=line>        <span class=keyword>for</span> (<span class=keyword>var</span> i = <span class=number>0</span>; i &lt; data.Js.length; i++)</div><div class=line>            Loader.loadJs(data.Js[i]);</div><div class=line>    &#125;</div><div class=line></div><div class=line>    <span class=keyword>return</span> &#123; <span class=attr>loadCss</span>: loadCss, <span class=attr>loadJs</span>: loadJs &#125;;</div><div class=line>&#125;</div><div class=line></div><div class=line><span class=keyword>var</span> BigPipe = <span class=function><span class=keyword>function</span> (<span class=params>count</span>) </span>&#123;</div><div class=line></div><div class=line>    <span class=keyword>var</span> d = <span class=built_in>document</span>,</div><div class=line>       pagelets = []; 		<span class=comment>/* registered pagelets */</span></div><div class=line></div><div class=line>    <span class=keyword>var</span> onPageletArrive = <span class=function><span class=keyword>function</span> (<span class=params>p</span>) </span>&#123;</div><div class=line>        count = count || p.count;</div><div class=line>        <span class=keyword>var</span> pagelet = <span class=keyword>new</span> PageLet(p, <span class=function><span class=keyword>function</span> (<span class=params></span>) </span>&#123;</div><div class=line>            <span class=keyword>if</span> (! --count) &#123;</div><div class=line>                <span class=comment>//load js</span></div><div class=line>                <span class=keyword>for</span> (<span class=keyword>var</span> i = <span class=number>0</span>; i &lt; pagelets.length; i++)</div><div class=line>                    pagelets[i].loadJs();</div><div class=line>            &#125;</div><div class=line>        &#125;);</div><div class=line>        pagelets.push(pagelet);</div><div class=line>        pagelet.loadCss();</div><div class=line>    &#125;;</div><div class=line></div><div class=line>    <span class=keyword>return</span> &#123; <span class=attr>onPageletArrive</span>: onPageletArrive &#125;;</div><div class=line>&#125;;</div></pre></td></tr></table></figure><p>Once minimized using Google Closure, the size is 1.27KB (666 bytes gzipped), so we have a very small script that fits our requirements.</p><h2 id=Resources-chart><a href=#Resources-chart class=headerlink title="Resources chart"></a>Resources chart</h2><p>The following chart shows how resources are loaded: <img src=/assets/images/posts/bigpipe-02.jpg alt="Resources loading graph using BigPipe"></p><p>We can see that the main document flushes early, starting the requests for Site.css and BigPipe.js, which are in the head section of our view. When pagelets are executed (I have set a Thread.Sleep in both pagelets) their CSS resources are requested and only after they have been appended to the document their Javascript resources are downloaded and executed.</p><h2 id=Further-improvements><a href=#Further-improvements class=headerlink title="Further improvements"></a>Further improvements</h2><p>There are a lot of points that can be improved. I have thought of several of them, what could lead to a more complex solution that can provide BigPipe to ASP.Net MVC in a not so experimental way.</p><h3 id=Fire-event-before-starting-loading-js-for-pagelets><a href=#Fire-event-before-starting-loading-js-for-pagelets class=headerlink title="Fire event before starting loading js for pagelets"></a>Fire event before starting loading js for pagelets</h3><p>Scripts that are needed by the page but do not need to be loaded before executing pagelets can be delayed and be requested when the pagelets’ scripts are.</p><h3 id=Manage-dependencies-between-scripts><a href=#Manage-dependencies-between-scripts class=headerlink title="Manage dependencies between scripts"></a>Manage dependencies between scripts</h3><p>As Facebook does, it can be a good idea to incorporate dependencies solving logic to request and execute JavaScript resources in the best order.</p><p>Avoid double insertion. If two pagelets require the same script, it is only necessary to request once.</p><h3 id=Manage-pagelets-resources-in-a-unique-place><a href=#Manage-pagelets-resources-in-a-unique-place class=headerlink title="Manage pagelets resources in a unique place"></a>Manage pagelets resources in a unique place</h3><p>In my solution, pagelets’ resources are specified in the view that is including them. If we decide to change the implementation of a pagelet and now we need a different set of resources (i.e. an extra JS resource)</p><h2 id=Drawbacks-of-this-implementation><a href=#Drawbacks-of-this-implementation class=headerlink title="Drawbacks of this implementation"></a>Drawbacks of this implementation</h2><p>At first I see a performance problem when the browser does not support Javascript. As we are registering pagelets as PartialViews rendered inside the body ContentPlaceHolder, we have no way to include CSS resources back to the head section, since it has already been generated. So we have to include the CSS link elements inside the body, blocking renderization.</p><p>The good thing is that we save bytes not writing script elements when we detect the browser has JavaScript disabled.</p></div><hr></article></div><footer><section class=links><a href=https://twitter.com/jmperezperez>@jmperezperez</a> on Twitter · <a href=https://github.com/JMPerez>GitHub</a> · <a href=http://www.linkedin.com/in/jmperezperez>LinkedIn</a> · <a href=https://plus.google.com/107456024651797783420>Google+</a></section></footer></body></html>